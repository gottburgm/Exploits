<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [
   <!ENTITY libraries SYSTEM "../thirdparty/libraries.ent">
   <!ENTITY testsuite-libraries SYSTEM "../thirdparty/testsuite-libraries.ent">
   <!ENTITY modules SYSTEM "../tools/etc/buildmagic/modules.ent">
]>

<!-- ============================================================ -->
<!--  JBoss, the OpenSource J2EE webOS                            -->
<!--  Distributable under LGPL license.                           -->
<!--  See terms of license at http://www.gnu.org.                 -->
<!-- ============================================================ -->

<!-- $Id$ -->

<project default="main" name="JBoss/Testsuite"
         xmlns:server="http://jboss.org/ns/test/ant/server">
   <import file="../tools/etc/buildmagic/build-common.xml"/>

   <!-- Tests requiring separate server configurations -->
   <import file="imports/config/configs.xml"/>

   <!-- ======================================================== -->
   <!-- Initialization                                           -->
   <!-- ======================================================== -->
   <tstamp>
      <format property="TIMENOW" pattern="yyyy-MM-dd.HH-mm" timezone="GMT"/>
   </tstamp>
   <echo message="${TIMENOW}" file="run.tstamp"/>

   <property name="results_web" value="http://jboss.sourceforge.net/junit-results/32"/>
   <property name="buildlog.level" value="info" />
   <property environment="env"/>

   <!-- Set a hostname property based on COMPUTERNAME for win32, HOSTNAME
   otherwise and initialize the node0/node1 cluster hostnames to localhost
   and ${hostname} by default. If you cannot route multicast traffic between
   localhost and hostname, then you need to specify node0 and node1 binding
   in the local.properties that can in order to be able to run the clustering
   tests.
   -->
   <condition property="hostname" value="${env.COMPUTERNAME}">
      <os family="windows"/>
   </condition>
   <condition property="hostname" value="${env.HOSTNAME}">
      <not>
         <os family="windows"/>
      </not>
   </condition>

   <!--We will use local.properties file to provide some configuration
       to the testsuite mainly for the Clustering framework. Please
       do not checkin your local.properties file into CVS-->
   <property file="local.properties"/>

   <!-- Set a property if we know this is a Sun VM. Can be
        used to enable/disable things based on VM vendor -->
   <condition property="sun-vm" value="true">
   	  <and>
         <equals arg1="Sun Microsystems Inc." arg2="${java.vendor}" trim="true"/>
   	  	 <not>
   	  	 	<!-- Pass -Dignore.sun-vm.override=true to ant to bypass
   	  	 	     enabling/disabling things based on Sun being VM vendor -->
   	  	 	<isset property="ignore.sun-vm.override"/>
   	  	 </not>
   	  </and>
   </condition>

   <!-- Cluster node0 defaults -->
   <property name="node0" value="localhost" />
   <property name="node0.http.url" value="http://${node0}:8080" />
   <property name="node0.jndi.url" value="jnp://${node0}:1099" />
   <property name="node0.hajndi.url" value="jnp://${node0}:1100" />
   <property name="node0.jndi.http.url" value="http://${node0}:8080/invoker/JNDIFactory" />
   <!-- Cluster node1 defaults -->
   <property name="node1" value="${hostname}" />
   <property name="node1.http.url" value="http://${node1}:8080" />
   <property name="node1.jndi.url" value="jnp://${node1}:1099" />
   <property name="node1.hajndi.url" value="jnp://${node1}:1100" />
   <property name="node1.jndi.http.url" value="http://${node1}:8080/invoker/JNDIFactory" />

   <!-- Client artefacts default -->
   <property name="target.node" value="${node0}" />
   
   
   <!-- UDP Group -->
   <!-- The value of the -u option passed to jboss -->
   <!-- A blank value will prevent the -u option from being passed -->
   <!-- Override this in the local.properties or pass to Ant as -DupdGroup=128.x.x.x -->
   <property name="udpGroup" value=""/>
   <!-- Same thing, but passed to the client -->
   <property name="jbosstest.udpGroup" value="${udpGroup}"/>
  
   <!-- PartitionName -->
   <!-- The value of the -g option passed to jboss in some configs -->
   <!-- Override this in the local.properties or pass to Ant as -DpartitionName=FooPartition -->
   <property name="partitionName" value="DefaultPartition"/>
   <!-- Same thing, but passed to the client -->
   <property name="jbosstest.partitionName" value="${partitionName}"/>
	
	<!-- Default Amazon S3 values. The correct values need to be set externally -->
	<property name="s3_ping.access_key" value="CHANGEIT"/>
	<property name="s3_ping.secret_access_key" value="CHANGEIT"/>
	<property name="s3_ping.bucket" value="CHANGEIT"/>
	
   <!-- =================== -->
   <!-- Basic Configuration -->
   <!-- =================== -->

   <!-- Module name(s) & version -->
   <property name="module.name" value="testsuite"/>
   <property name="module.Name" value="JBoss Testsuite"/>
   <property name="module.version" value="DEV"/>

   <!-- distribution to test against - use the default build if -Djboss.dist is not defined -->
   <!-- Use the ${/} platform seperator in jboss.dist, jboss.test.deploy.dir as
      this is used in the security policy file property references and needs to
      be valid for the platform.
   -->
   <property name="version" value="${version.major}.${version.minor}.${version.revision}"/>
   <property name="jboss.dist.default" value="${project.root}${/}build${/}output${/}jboss-${version}"/>
   <condition property="jboss.dist" value="${jboss.dist.default}">
     <not>
       <isset property="jboss.dist"/>
     </not>
   </condition>

   <!-- ========= -->
   <!-- Libraries -->
   <!-- ========= -->

   &libraries;
   &testsuite-libraries;

   <!-- The combined library classpath (for building the testsuite) -->
   <path id="library.classpath">
      <path refid="apache.commons.classpath"/>
      <path refid="apache.codec.classpath"/>
      <path refid="apache.log4j.classpath"/>
      <path refid="apache.jaxme.classpath"/>
      <path refid="apache.scout.classpath"/>
      <path refid="apache.xerces.classpath"/>
      <path refid="org.apache.santuario.classpath"/>
      <path refid="dom4j.dom4j.classpath"/>
      <path refid="httpunit.httpunit.classpath"/>
      <path refid="ibm.wsdl4j.classpath"/>
      <path refid="jacorb.jacorb.classpath"/>
      <path refid="jboss.cache.jbosscache.core.classpath"/>
      <path refid="jboss.cache.jbosscache.pojo.classpath"/>
      <path refid="jgroups.jgroups.classpath"/>
      <path refid="joesnmp.joesnmp.classpath"/>
      <path refid="junit.junit.classpath"/>
      <path refid="org.easymock.classpath"/>
      <path refid="javassist.classpath"/>
      <path refid="juddi.juddi.classpath"/>
      <path refid="nekohtml.nekohtml.classpath"/>
      <path refid="objectweb.joramtests.classpath"/>
      <path refid="opensaml.opensaml.classpath"/>
      <path refid="oswego.concurrent.classpath"/>
      <path refid="sleepycat.classpath"/>
      <path refid="sun.jaf.classpath"/>
      <path refid="sun.javamail.classpath"/>
      <path refid="sun.jaxb.classpath"/>
      <path refid="sun.jsf.classpath"/>
      <path refid="jboss.web.classpath"/>
      <path refid="trove.classpath"/>
      <path refid="wutka.dtdparser.classpath"/>
      <path refid="woodstox.woodstox.classpath"/>
      <path refid="org.jboss.cluster.classpath"/>
      <path refid="org.jboss.jaxr.classpath"/>
      <path refid="jboss.remoting.classpath"/>
      <path refid="jboss.serialization.classpath"/>
      <path refid="jboss.jboss.ejb3.core.classpath" />
      <path refid="jboss.jboss.ejb3.ext.api.classpath" />
      <path refid="jboss.jboss.ejb3.proxy.impl.classpath" />
      <path refid="jboss.jboss.ejb3.proxy.spi.classpath" />
      <path refid="jboss.jboss.ejb3.transactions.classpath" />
      <path refid="ejb3-persistence.classpath"/>
      <path refid="org.jboss.ws.native.classpath"/>
      <path refid="org.jboss.spec.javax.xml.rpc.classpath"/>
      <path refid="saaj.api.classpath"/>
      <path refid="org.jboss.ws.classpath"/>
      <path refid="jboss.jbossxb.classpath"/>
      <path refid="jboss.metadata.classpath"/>
      <path refid="jboss.integration.classpath"/>
      <path refid="jboss.profileservice.spi.classpath"/>
      <path refid="stax.api.classpath"/>
      <!-- needed for messaging JMS provider tests -->
      <path refid="jboss.messaging.classpath"/>
      <!-- needed for proxy tests -->
      <path refid="apache.bcel.classpath"/>
      <!-- needed for security login module tests -->
      <path refid="hsqldb.hsqldb.classpath"/>
      <!-- Need hibernate jar for hibernate-based tests -->
      <path refid="hibernate3.classpath"/>
      <path refid="odmg.classpath"/>
      <path refid="cglib.classpath"/>
     <!-- Need spring jar for spring-based tests -->
     <path refid="spring.classpath"/>

      <!-- xml binding -->
      <path refid="xmlunit.xmlunit.classpath"/>
      <path refid="jboss.jboss.reflect.classpath"/>
      <path refid="jboss.jboss.mdr.classpath"/>
      <path refid="jboss.jboss.man.classpath"/>
      <path refid="jboss.jboss.deployers.classpath"/>
      <path refid="jboss.jboss.cl.classpath"/>
      <path refid="jboss.microcontainer.classpath"/>

   	  <!-- For classloader leak tests -->
      <path refid="jboss.profiler.jvmti.classpath"/>
			
      <!-- org.jboss.aspects:jboss-aspects -->
      <path refid="org.jboss.aspects.classpath"/>
      <!-- hibernate tests need slfj4 -->
      <path refid="org.jboss.slf4j.classpath"/>
      <path refid="org.slf4j.classpath"/>
      <!-- JBAS-6934 -->
      <path refid="net.jcip.classpath"/>
      <!-- jbossts crash recovery tests need server manager -->
      <path refid="jboss.server.manager.classpath"/>
      <path refid="jboss.jbossts.classpath"/>
      <!-- JBoss Negotiation -->
      <path refid="jboss.jboss.negotiation.classpath" />
   </path>

   <property name="jboss.dist.client" value="${jboss.dist}/client" />
   <property name="jboss.dist.lib" value="${jboss.dist}/lib" />
   <property name="jboss.dist.lib.endorsed" value="${jboss.dist.lib}/endorsed" />
   <property name="jboss.dist.common.lib" value="${jboss.dist}/common/lib" />
   <property name="jboss.dist.server" value="${jboss.dist}/server" />

   <!-- the combined library classpath (for executing the testsuite) -->
   <path id="distribution.jars.library.classpath">
      <!-- path refid="apache.commons.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/commons-collections.jar" />
      <pathelement path="${jboss.dist.client}/commons-logging.jar" />
      <pathelement path="${apache.httpclient.lib}/commons-httpclient.jar" />
      <pathelement path="${apache.discovery.lib}/commons-discovery.jar" />
      <pathelement path="${apache.fileupload.lib}/commons-fileupload.jar" />
      <pathelement path="${apache.lang.lib}/commons-lang.jar" />
      <!-- path refid="apache.codec.classpath"/ -->
      <pathelement path="${apache.codec.lib}/commons-codec.jar" />
      <!-- path refid="apache.log4j.classpath"/ -->
      <pathelement path="${jboss.dist.client}/log4j.jar" />
      <!-- path refid="apache.jaxme.classpath"/ -->
      <pathelement path="${apache.jaxme.lib}/jaxmexs.jar" />
      <!-- path refid="apache.scout.classpath"/ -->
      <pathelement path="${jboss.dist.client}/scout.jar" />
      <!-- path refid="apache.xerces.classpath"/ -->
      <pathelement path="${jboss.dist.lib.endorsed}/resolver.jar" />
      <pathelement path="${jboss.dist.lib.endorsed}/xercesImpl.jar" />
      <pathelement path="${apache.xerxes.lib}/xml-apis.jar" />
      <!-- path refid="org.apache.santuario.classpath"/ -->
      <pathelement path="${jboss.dist.client}/xmlsec.jar" />
      <!-- path refid="dom4j.dom4j.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/dom4j.jar" />
      <!-- path refid="httpunit.httpunit.classpath"/ -->
      <pathelement path="${httpunit.httpunit.lib}/httpunit.jar" />
      <!-- path refid="rhino.rhino.classpath"/ -->
      <pathelement path="${rhino.rhino.lib}/js.jar" />
      <!-- path refid="ibm.wsdl4j.classpath"/ -->
      <pathelement path="${jboss.dist.client}/wsdl4j.jar" />
      <!-- path refid="jacorb.jacorb.classpath"/ -->
      <pathelement path="${jacorb.jacorb.lib}/idl.jar" />
      <pathelement path="${jacorb.jacorb.lib}/idl_g.jar" />
      <pathelement path="${jboss.dist.client}/jacorb.jar" />
      <pathelement path="${jacorb.jacorb.lib}/jacorb_g.jar" />
      <!-- path refid="jboss.cache.jbosscache.core.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/lib/jbosscache-core.jar" />
      <!-- path refid="jboss.cache.jbosscache.pojo.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/lib/jbosscache-pojo.jar" />
      <!-- path refid="jgroups.jgroups.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/lib/jgroups.jar" />
      <!-- path refid="joesnmp.joesnmp.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/joesnmp.jar" />
      <!-- path refid="junit.junit.classpath"/ -->
      <pathelement path="${junit.junit.lib}/junit.jar" />
      <!-- path refid="org.easymock.classpath"/ -->
      <pathelement path="${org.easymock.lib}/easymock.jar" />
      <!-- path refid="javassist.classpath"/ -->
      <pathelement path="${jboss.dist.client}/javaassist.jar" />
      <!-- path refid="juddi.juddi.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/deploy/juddi-service.sar/juddi.jar" />
      <!-- path refid="nekohtml.nekohtml.classpath"/ -->
      <pathelement path="${nekohtml.nekohtml.lib}/nekohtml.jar" />
      <!-- path refid="objectweb.joramtests.classpath"/ -->
      <pathelement path="${objectweb.joramtests.lib}/joramtests.jar" />
      <!-- path refid="opensaml.opensaml.classpath"/ -->
      <pathelement path="${opensaml.opensaml.lib}/opensaml.jar" />
      <!-- path refid="oswego.concurrent.classpath"/ -->
      <pathelement path="${jboss.dist.client}/concurrent.jar" />
      <!-- path refid="sleepycat.classpath"/ -->
      <pathelement path="${sleepycat.sleepycat.lib}/je.jar" />
      <!-- path refid="sun.jaf.classpath"/ -->
      <pathelement path="${jboss.dist.client}/activation.jar" />
      <!-- path refid="sun.javamail.classpath"/ -->
      <pathelement path="${jboss.dist.client}/mail.jar" />
      <!-- path refid="sun.jaxb.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jaxb-api.jar" />
      <pathelement path="${jboss.dist.client}/jaxb-impl.jar" />
      <pathelement path="${jboss.dist.client}/jaxb-xjc.jar" />
      <!-- path refid="sun.jsf.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/deploy/jbossweb.sar/jsf-libs/jsf-api.jar" />
      <pathelement path="${jboss.dist}/all/deploy/jbossweb.sar/jsf-libs/jsf-impl.jar" />
      <!-- jboss.web.classpath -->
      <pathelement path="${jboss.dist.common.lib}/el-api.jar" />
      <pathelement path="${jboss.dist}/all/deploy/jbossweb.sar/jasper-jdt.jar" />
      <pathelement path="${jboss.dist}/all/deploy/jbossweb.sar/jbossweb.jar" />
      <pathelement path="${jboss.dist.common.lib}/jsp-api.jar" />
      <pathelement path="${jboss.dist.common.lib}/servlet-api.jar" />
      <!-- path refid="trove.classpath"/ -->
      <pathelement path="${jboss.dist.client}/trove.jar" />
      <!-- path refid="wutka.dtdparser.classpath"/ -->
      <pathelement path="${wutka.dtdparser.lib}/dtdparser.jar" />
      <pathelement path="${jboss.dist.common.lib}/dtdparser121.jar" />
      <!-- path refid="woodstox.woodstox.classpath"/ -->
      <pathelement path="${jboss.dist.client}/wstx.jar" />
      <!-- path refid="org.jboss.cluster.classpath" -->
      <pathelement path="${jboss.dist.client}/jboss-ha-client.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-ha-server-api.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-ha-server-cache-jbc.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-ha-server-cache-spi.jar" />
      <!-- path refid="org.jboss.jaxr.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/deploy/juddi-service.sar/juddi-saaj.jar" />
      <pathelement path="${jboss.dist.server}/all/deploy/juddi-service.sar/juddi-service.jar" />
      <!-- path refid="jboss.remoting.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-remoting.jar" />
      <!-- path refid="jboss.serialization.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-serialization.jar" />
      <!-- path refid="jboss.jboss.ejb3.context.base.classpath" / -->
      <pathelement path="${jboss.dist.common.lib}/jboss-ejb3-context-base.jar" />
      <!-- path refid="jboss.jboss.ejb3.core.classpath" / -->
      <pathelement path="${jboss.dist.client}/jboss-ejb3-core-client.jar" />  
      <pathelement path="${jboss.dist.common.lib}/jboss-ejb3-core.jar" />
      <!-- ejb3 deployer classpath -->
      <pathelement path="${jboss.dist.server}/production/deployers/ejb3.deployer/jboss-ejb3-deployer.jar" />
      <path refid="jboss.jboss.jpa.deployers.classpath" />
      <!-- path refid="jboss.jboss.ejb3.ext.api.classpath" / -->
      <pathelement path="${jboss.dist.client}/jboss-ejb3-ext-api.jar" />
      <!-- path refid="jboss.jboss.ejb3.proxy.impl.classpath" / -->
      <pathelement path="${jboss.dist.client}/jboss-ejb3-proxy-impl-client.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-ejb3-proxy-impl.jar" />
      <!-- path refid="jboss.jboss.ejb3.proxy.spi.classpath" / -->
      <pathelement path="${jboss.dist.client}/jboss-ejb3-proxy-spi-client.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-ejb3-proxy-spi.jar" />
      <!-- path refid="ejb3-persistence.classpath"/ -->
      <pathelement path="${jboss.dist.client}/hibernate-annotations.jar" />
      <pathelement path="${jboss.dist.client}/ejb3-persistence.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-entitymanager.jar" />
      <!-- path refid="org.jboss.ws.native.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jbossws-native-client.jar" />
      <pathelement path="${jboss.dist.client}/jbossws-native-core.jar" />
      <pathelement path="${jboss.dist.client}/jbossws-native-jaxws-ext.jar" />
      <pathelement path="${jboss.dist.client}/jbossws-native-jaxws.jar" />
      <pathelement path="${org.jboss.ws.native.lib}/jbossws-native-management.war" />
      <pathelement path="${org.jboss.ws.native.lib}/jbossws-native-resources.jar" />
      <pathelement path="${org.jboss.spec.javax.xml.rpc.lib}/jboss-jaxrpc-api_1.1_spec.jar"/>
      <pathelement path="${saaj.api.lib}/saaj-api.jar"/>
      <!-- path refid="org.jboss.ws.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jbossws-common.jar" /> 
      <pathelement path="${jboss.dist.client}/jbossws-framework.jar" />
      <pathelement path="${jboss.dist.client}/jbossws-spi.jar" />
      <!-- path refid="jboss.jbossxb.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-xml-binding.jar" />
      <!-- path refid="jboss.metadata.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-metadata.jar" />
      <!-- path refid="jboss.integration.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-classloading-spi.jar" />
      <pathelement path="${jboss.integration.lib}/jboss-corba-ots-spi.jar" />
      <pathelement path="${jboss.integration.lib}/jboss-deployment-spi.jar" />
      <pathelement path="${jboss.dist.client}/jboss-integration.jar" />  
      <pathelement path="${jboss.integration.lib}/jboss-transaction-spi.jar" />
      <!-- path refid="jboss.profileservice.spi.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-profileservice-spi.jar" />
      <!-- path refid="stax.api.classpath"/ -->
      <pathelement path="${jboss.dist.lib.endorsed}/stax-api.jar" />
      <!-- needed for messaging JMS provider tests -->
      <!-- path refid="jboss.messaging.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-messaging-client.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-messaging.jar" />
      <!-- needed for proxy tests -->
      <!-- path refid="apache.bcel.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/bcel.jar" />
      <!-- needed for security login module tests -->
      <!-- path refid="hsqldb.hsqldb.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/hsqldb.jar" />
      <!-- Need hibernate jar for hibernate-based tests -->
      <!-- same as hibernate classpath -->
      <!-- path refid="hibernate3.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/hibernate-core.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-jmx.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-ehcache.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-oscache.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-swarmcache.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-c3p0.jar" />
      <pathelement path="${jboss.dist.common.lib}/hibernate-proxool.jar" />
      <!-- path refid="odmg.classpath"/ -->
      <pathelement path="${odmg.odmg.lib}/odmg-3.0.jar" />
      <!-- path refid="cglib.classpath"/ -->
      <pathelement path="${cglib.cglib.lib}/cglib.jar" />
      <!-- Need spring jar for spring-based tests -->
      <!-- same as spring.spring.classpath -->
      <!-- path refid="spring.classpath"/ -->
      <pathelement path="${spring.spring.lib}/spring-aop.jar" />
      <pathelement path="${spring.spring.lib}/spring-beans.jar" />
      <pathelement path="${spring.spring.lib}/spring-context.jar" />
      <pathelement path="${spring.spring.lib}/spring-core.jar" />
      <pathelement path="${spring.spring.lib}/spring-web.jar" />
      <pathelement path="${spring.spring.lib}/spring-webmvc.jar" />
      <!-- xml binding -->
      <!-- path refid="xmlunit.xmlunit.classpath"/ -->
      <pathelement path="${xmlunit.xmlunit.lib}/xmlunit1.0.jar" />
      <!-- path refid="jboss.jboss.reflect.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-reflect.jar" />
      <!-- path refid="jboss.jboss.mdr.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-mdr.jar" />
      <!-- path refid="jboss.jboss.man.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-managed.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-metatype.jar" />
      <!-- path refid="jboss.jboss.deployers.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-deployers-client-spi.jar" />
      <pathelement path="${jboss.dist.client}/jboss-deployers-client.jar" />
      <pathelement path="${jboss.dist.client}/jboss-deployers-core-spi.jar" />
      <pathelement path="${jboss.dist.client}/jboss-deployers-core.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-deployers-impl.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-deployers-spi.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-deployers-structure-spi.jar" />
      <pathelement path="${jboss.dist.client}/jboss-deployers-vfs-spi.jar" />
      <pathelement path="${jboss.dist.client}/jboss-deployers-vfs.jar" />
      <!-- path refid="jboss.jboss.cl.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-classloader.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-classloading-vfs.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-classloading.jar" />
      <!-- path refid="jboss.microcontainer.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-aop-mc-int.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-dependency.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-kernel.jar" />
      <!-- For classloader leak tests -->
      <!-- path refid="jboss.profiler.jvmti.classpath"/ -->
      <pathelement path="${jboss.profiler.jvmti.lib}/jboss-profiler-jvmti.jar" />
      <!-- org.jboss.aspects:jboss-aspects -->
      <!-- path refid="org.jboss.aspects.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-current-invocation-aspects.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-remoting-aspects.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-security-aspects.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-transaction-aspects.jar" />
      <!-- hibernate tests need slfj4 -->
      <!-- path refid="org.jboss.slf4j.classpath"/ -->
      <pathelement path="${jboss.dist.client}/slf4j-jboss-logging.jar" />
      <!-- path refid="org.slf4j.classpath"/ -->
      <pathelement path="${jboss.dist.client}/slf4j-api.jar" />
      <!-- JBAS-6934 -->
      <!-- path refid="net.jcip.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/lib/jcip-annotations.jar" />
      <!-- jbossts crash recovery tests need server manager -->
      <!-- path refid="jboss.server.manager.classpath"/ -->
      <pathelement path="${jboss.server.manager.lib}/jboss-server-manager.jar" />
      <!-- path refid="jboss.jbossts.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jbossjts-integration.jar" />
      <pathelement path="${jboss.dist.client}/jbossjts-jacorb.jar" />
      <pathelement path="${jboss.dist.client}/jbossjts.jar" />
      <pathelement path="${jboss.dist.common.lib}/jbossts-common.jar" />
      <pathelement path="${jboss.dist}/docs/examples/transactions/jbossts-tools.sar" />
      <pathelement path="${jboss.dist}/docs/examples/transactions/jbossxts.sar" />
   </path>

   <!-- ======= -->
   <!-- Modules -->

   &modules;

   <!-- ======= -->
   <!-- InternalServer -->
   <!-- This could be a mistake.  Perhaps, though, it would be a good idea to separate
   tests that need internal jboss classes from those that don't.  When I put it in, only
   the jca XATxConnectionManagerUnitTestCase needed an internal class (the tx manager)-->
   <property name="jboss.internal-server.root" value="${project.root}/server/output"/>
   <property name="jboss.internal-server.lib" value="${jboss.internal-server.root}/lib"/>
   <path id="jboss.internal-server.classpath">
      <pathelement path="${jboss.server.lib}/jboss.jar"/>
      <pathelement path="${jboss.server.lib}/jboss-main.jar"/>
      <pathelement path="${jboss.server.lib}/jboss-system.jar"/>
   </path>

   <!-- The combined dependant module classpath (for building the testsuite) -->
   <path id="dependentmodule.classpath">
      <path refid="jboss.aop.classpath"/>
      <path refid="jboss.aspects.classpath"/>
      <path refid="jboss.cluster.classpath"/>
   	  <path refid="jboss.common.beans.classpath"/>
      <path refid="jboss.common.core.classpath"/>
      <path refid="jboss.common.logging.spi.classpath"/>
      <path refid="jboss.common.logging.log4j.classpath"/>
      <path refid="jboss.common.logging.jdk.classpath"/>
      <path refid="jboss.deployment.classpath"/>
      <path refid="jboss.hibernate.classpath"/>
      <path refid="jboss.iiop.classpath"/>
      <path refid="jboss.internal-server.classpath"/>
      <path refid="jboss.j2se.classpath"/>
      <path refid="jboss.jboss.jaspi.api.classpath"/>
      <path refid="jboss.jboss.javaee.classpath"/>
      <path refid="org.jboss.javaee.classpath"/>
      <path refid="jboss.jboss.vfs.classpath"/>
      <path refid="jboss.jca.classpath"/>
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.management.classpath"/>
      <path refid="jboss.mbeans.classpath"/>
      <path refid="jboss.mq.classpath"/>
      <path refid="jboss.jnpserver.classpath"/>
      <path refid="jboss.profileservice.classpath"/>
      <path refid="jboss.jboss.security.spi.classpath"/>
      <path refid="jboss.jbosssx.classpath"/>
      <path refid="jboss.security.int.classpath"/>
      <path refid="jboss.server.classpath"/>
      <path refid="jboss.main.classpath"/>
      <path refid="jboss.jboss.bootstrap.classpath"/>
      <path refid="jboss.system.classpath"/>
      <path refid="jboss.systemjmx.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="jboss.tomcat.classpath"/>
      <path refid="jboss.varia.classpath"/>
      <path refid="jboss.web.classpath"/>
      <path refid="jboss.spring.classpath"/>
   </path>

   <!-- the combined dependent modules classpath (for executing the testsuite) -->
   <path id="distribution.jars.dependentmodule.classpath">
      <!-- path refid="jboss.aop.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-aop-asintegration-core.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-aop-asintegration-jmx.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-aop-asintegration-mc.jar" />
      <pathelement path="${jboss.dist.server}/all/deployers/jboss-aop-jboss5.deployer/jboss-aop-aspects.jar" />
      <pathelement path="${jboss.dist.client}/jboss-aop-client.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-aop-deployers.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-aop.jar" />
      <pathelement path="${jboss.dist.server}/all/deployers/jboss-aop-jboss5.deployer/pluggable-instrumentor.jar" />
      <!-- path refid="jboss.aspects.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/deployers/jboss-aop-jboss5.deployer/jboss-aspect-library.jar" />
      <!--  jbossha-httpsession.jar, jbossha-singleton.jar, <some resources> no longer exist -->
      <!-- path refid="jboss.cluster.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jbossha.jar" />
      <!-- path refid="jboss.common.core.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-common-core.jar" />
      <!-- path refid="jboss.common.logging.spi.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-logging-spi.jar" />
      <!-- path refid="jboss.common.logging.log4j.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-logging-log4j.jar" />
      <!-- path refid="jboss.common.logging.jdk.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-logging-jdk.jar" />
      <!-- path refid="jboss.deployment.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-deployment.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-jsr88.jar" />
      <!-- path refid="jboss.hibernate.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-hibernate.jar" />
      <!-- path refid="jboss.iiop.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-iiop.jar" />
      <!-- path refid="jboss.internal-server.classpath" / -->
      <pathelement path="${jboss.dist.common.lib}/jboss.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-main.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-system.jar" />
      <!-- path refid="jboss.j2se.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-j2se.jar" />
      <!-- path refid="jboss.jboss.jaspi.api.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-jaspi-api.jar" />
      <!-- path refid="jboss.jboss.javaee.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-javaee.jar" />
      <!-- path refid="org.jboss.javaee.classpath" / -->
      <pathelement path="${org.jboss.javaee.lib}/jboss-ejb-api.jar" />
      <pathelement path="${org.jboss.javaee.lib}/jboss-jacc-api.jar" />
      <pathelement path="${org.jboss.javaee.lib}/jboss-jad-api.jar" />
      <pathelement path="${org.jboss.javaee.lib}/jboss-jca-api.jar" />
      <pathelement path="${org.jboss.javaee.lib}/jboss-jms-api.jar" />
      <pathelement path="${org.jboss.javaee.lib}/jboss-transaction-api.jar" />
      <!-- path refid="jboss.jboss.vfs.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-vfs.jar" />
      <!-- path refid="jboss.jca.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-jca.jar" />
      <pathelement path="${jboss.dist.server}/all/deployers/jboss-jca.deployer/jboss-jca-deployer.jar" />
      <pathelement path="${jboss.jca.lib}/jboss-local-jdbc.jar" />
      <pathelement path="${jboss.jca.lib}/jboss-xa-jdbc.jar" />
      <pathelement path="${jboss.jca.lib.lib}/jboss-ha-local-jdbc.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-common-jdbc-wrapper.jar" />
      <!-- path refid="jboss.jmx.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-jmx.jar" />
      <!-- path refid="jboss.jmx-remoting.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-jmx-remoting.jar" />
      <!-- path refid="jboss.management.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-jsr77-client.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-jsr77.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-management.jar" />
      <!-- path refid="jboss.mbeans.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-mbeans.jar" />
      <!-- jbossmq.jar no longer exists -->
      <!-- path refid="jboss.mq.classpath"/ -->
      <!-- path refid="jboss.jnpserver.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jnpserver.jar" />
      <!-- path refid="jboss.profileservice.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-profileservice.jar" />
      <!-- path refid="jboss.jboss.security.spi.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-security-spi.jar" />
      <!-- jbosssx.jar  -->
      <!-- path refid="jboss.jbosssx.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jbosssx.jar" />
      <!-- path refid="jboss.security.int.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jbosssx-server.jar" />
      <!-- path refid="jboss.server.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss.jar" />
      <pathelement path="${jboss.dist.common.lib}/jmx-adaptor-plugin.jar" />
      <!-- path refid="jboss.main.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-main.jar" />
      <!-- jboss-bootstrap.jar  <from thirdparty> -->
      <!-- path refid="jboss.jboss.bootstrap.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-bootstrap.jar" />
      <!-- path refid="jboss.system.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-system.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-profileservice-spi.jar" />
      <!-- path refid="jboss.systemjmx.classpath"/ -->
      <pathelement path="${jboss.dist.client}/jboss-system-jmx-client.jar" />
      <pathelement path="${jboss.dist.lib}/jboss-system-jmx.jar" />
      <!-- path refid="jboss.test.classpath"/ -->
      <pathelement path="${jboss.test.lib}/jboss-test.jar" />
      <!-- path refid="jboss.tomcat.classpath"/ -->
      <pathelement path="${jboss.dist.server}/all/deploy/cluster/jbossweb-cluster.aop" />
      <pathelement path="${jboss.dist.server}/all/deploy/jbossweb.sar/jboss-web-service.jar" />
      <pathelement path="${jboss.dist.server}/all/deployers/jbossweb.deployer/jboss-web-deployer.jar" />
      <!-- path refid="jboss.varia.classpath"/ -->
      <pathelement path="${jboss.varia.root}/classes"/>
      <!-- path refid="jboss.web.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/el-api.jar" />
      <pathelement path="${jboss.dist.server}/all/deploy/jbossweb.sar/jasper-jdt.jar" />   
      <pathelement path="${jboss.dist.server}/all/deploy/jbossweb.sar/jbossweb.jar" />
      <pathelement path="${jboss.dist.common.lib}/jsp-api.jar" />
      <pathelement path="${jboss.dist.common.lib}/servlet-api.jar" />
   	  <path refid="jboss.common.beans.classpath"/>
      <!-- jboss-spring.jar (not copied into distro) -->
      <!-- path refid="jboss.spring.classpath"/ -->
   </path>


   <!-- RMI Stub generation -->
   <patternset id="rmic.includes"
      description="The patternset passed to the compile-stubs target">
      <include name="org/jboss/test/cluster/test/DistributedStateTestCase$TestListener.class"/>
      <include name="org/jboss/test/cluster/test/DRMTestCase$TestListener.class"/>
      <include name="org/jboss/test/cts/test/ClientCallbackImpl.class"/>
      <include name="org/jboss/test/jmx/invoker/RMIBadListener.class"/>
      <include name="org/jboss/test/jmx/invoker/RMIListener.class"/>
   </patternset>

   <!-- ===== -->
   <!-- Tasks -->
   <!-- ===== -->

   <!-- Where source files live -->
   <property name="source.java" value="${module.source}/main"/>
	 <property name="source.java.5" value="${module.source}/jdk15"/>
   <property name="source.etc" value="${module.source}/etc"/>
   <property name="source.docs" value="${module.source}/docs"/>
   <property name="source.resources" value="${module.source}/resources"/>
   <property name="source.stylesheets" value="${module.source}/stylesheets"/>

   <!-- Where build generated files will go -->
   <property name="build.classes" value="${module.output}/classes"/>
   <property name="build.lib" value="${module.output}/lib"/>
   <property name="build.api" value="${module.output}/api"/>
   <property name="build.etc" value="${module.output}/etc"/>
   <property name="build.docs" value="${module.output}/docs"/>
   <property name="build.resources" value="${module.output}/resources"/>
   <property name="build.stylesheets" value="${module.output}/stylesheets"/>
   <property name="build.reports" value="${module.output}/reports"/>
   <!--<property name="build.testlog" value="${java.io.tmpdir}"/>-->
   <property name="build.testlog" value="${module.output}/log"/>
   <property name="build.gen-src" value="${module.output}/gen-src/"/>

   <!-- Install/Release structure -->
   <property name="install.id" value="${module.name}-${module.version}"/>
   <property name="release.id" value="${install.id}"/>
   <property name="install.root" value="${module.output}/${install.id}"/>

   <!-- The combined thirdparty classpath -->
   <path id="thirdparty.classpath">
      <path refid="library.classpath"/>
      <path refid="dependentmodule.classpath"/>
   </path>

   <path id="javac.classpath">
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- classpath and local.classpath must have a value using with a path -->
   <property name="classpath" value=""/>
   <property name="local.classpath" value=""/>

   <!-- Classpath to build and run the tests -->
   <path id="tests.compile.classpath">
      <pathelement path="${classpath}"/>
      <pathelement path="${local.classpath}"/>
      <pathelement path="${project.tools}/lib/ant.jar"/>
      <pathelement path="${project.tools}/lib/ant-junit.jar"/>
      <path refid="jboss.ejb3.classpath"/>
      <pathelement path="${jboss.dist.server}/production/deployers/ejb3.deployer/jboss-ejb3-deployer.jar" />
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="jboss.tomcat.classpath"/>
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- Import the jboss server run targets -->
   <import file="imports/server-config.xml"/>

   <!-- Classpath to build and run the tests -->
   <path id="tests.classpath.old">
     <fileset dir="${jboss.dist}/client">
       <include name="**/*.jar"/>
        <exclude name="jaxws-rt.jar"/>
        <exclude name="jaxws-tools.jar"/>
      </fileset>

      <pathelement path="${classpath}"/>
      <pathelement path="${local.classpath}"/>
      <pathelement path="${project.tools}/lib/ant.jar"/>
      <pathelement path="${project.tools}/lib/ant-junit.jar"/>
      <path refid="jboss.ejb3.classpath"/>
      <path refid="jboss.jmx.classpath"/>
      <path refid="jboss.jmx-remoting.classpath"/>
      <path refid="jboss.test.classpath"/>
      <path refid="thirdparty.classpath"/>
   </path>

   <!-- Classpath to build and run the tests against the distribution jars-->
   <path id="tests.classpath">
      <fileset dir="${jboss.dist}/client">
         <include name="**/*.jar" />
         <exclude name="jaxws-rt.jar" />
         <exclude name="jaxws-tools.jar" />
      </fileset>
      <pathelement path="${classpath}" />
      <pathelement path="${local.classpath}" />
      <pathelement path="${project.tools}/lib/ant.jar" />
      <pathelement path="${project.tools}/lib/ant-junit.jar" />
      <!-- this next path does not exist -->
      <!-- path refid="jboss.ejb3.classpath"/ -->
      <!-- path refid="jboss.jmx.classpath"/ -->
      <pathelement path="${jboss.dist.lib}/jboss-jmx.jar" />
      <!-- path refid="jboss.jmx-remoting.classpath"/ -->
      <pathelement path="${jboss.dist.common.lib}/jboss-jmx-remoting.jar" />
      <pathelement path="${jboss.dist.common.lib}/bsh.jar" />
      <pathelement path="${jboss.dist.common.lib}/jboss-negotiation.jar" />
      <path refid="jboss.test.classpath" />
      <path refid="distribution.jars.library.classpath" />
      <path refid="distribution.jars.dependentmodule.classpath" />
   </path>


   <!-- The classpath required to build javadocs. -->
   <path id="javadoc.classpath">
      <path refid="tests.compile.classpath"/>
   </path>

   <!-- The classpath for the compatibility matrix -->
   <path id="compatmatrix.classpath">
     <pathelement location="${build.classes}"/>
     <pathelement location="${build.resources}"/>
     <fileset dir="${jboss.dist}/client">
       <include name="jboss-deployers-client-spi.jar"/>
       <include name="jboss-deployers-core-spi.jar"/>
       <include name="jboss-client.jar"/>
       <include name="jboss-security-spi.jar"/>
       <include name="jboss-appclient.jar"/>
       <include name="jboss-messaging-client.jar"/>
       <include name="jbosssx-client.jar"/>
      </fileset>

     <path refid="jboss.test.classpath"/>
     <path refid="jboss.jboss.cl.classpath"/>
     <path refid="jboss.microcontainer.classpath"/>
     <path refid="jboss.jboss.reflect.classpath"/>
     <path refid="jboss.jboss.mdr.classpath"/>
     <path refid="hibernate.hibernate.classpath"/>
     <path refid="org.slf4j.classpath"/>
     <path refid="org.jboss.slf4j.classpath"/>
     <path refid="jboss.aop.classpath"/>
     <path refid="apache.codec.classpath"/>

     <fileset dir="${current-version-dir}" includes="*.jar"/>
     <pathelement path="${apache.httpclient.lib}/commons-httpclient.jar" />
   </path>

   <!-- Packages to include when generating api documentation -->
   <property name="javadoc.packages" value="org.jboss.*"/>

   <!-- Override JUnit defaults -->
   <property name="junit.timeout" value="180000"/> <!-- 3 minutes -->
   <property name="jbosstest.iterationcount" value="10"/>
   <property name="jbosstest.threadcount" value="5"/>
   <property name="jbosstest.beancount" value="5"/>
   <property name="jbosstest.nodeploy" value="false"/>
   <property name="jbosstest.src.etc" value="${source.etc}"/>
   <property name="junit.batchtest.todir" value="${build.reports}"/>
   <property name="junit.jvm.options" value="-Ddummy"/>
   <!-- Override JUnit Marathon defaults -->
   <property name="marathon.timeout" value="3900000"/> <!-- 65 minutes -->
   <property name="marathon.duration" value="3600000"/> <!-- 60 minutes -->
   <property name="marathon.threadcount" value="100"/>
   <propertyset id="jbosstest-props">
      <propertyref prefix="jbosstest."/>
   </propertyset>

  <!-- Choose between EAP and EWP build -->
  <condition property="build.ewp">
    <and>
      <isset property="version.name"/>
      <equals arg1="${version.name}" arg2="EWP"/>
    </and>
  </condition>

   <!-- Pass along whether we are running EWP to the tests -->
   <property name="jbosstest.ewp" value="${build.ewp}"/>

   <target name="init">
      <record name="${basedir}/build.log" append="yes" action="start" loglevel="error"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/ejb"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/interfaces"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/cts/service"/>
      <copy
         tofile="${build.gen-src}/org/jboss/test/cts/interfaces/CtsCmp2Local.java"
         file="${source.java}/org/jboss/test/cts/interfaces/CtsCmp2Local_V1.txt"
         overwrite="false"/>
      <copy tofile="${build.gen-src}/org/jboss/test/cts/ejb/CtsCmp2Bean.java"
         file="${source.java}/org/jboss/test/cts/ejb/CtsCmp2Bean_V1.txt"
         overwrite="flase"/>
      <copy
         tofile="${build.gen-src}/org/jboss/test/cts/service/CtsCmpService.java"
         file="${source.java}/org/jboss/test/cts/service/CtsCmpService_V1.txt"
         overwrite="false"/>
      <mkdir dir="${build.gen-src}/org/jboss/test/classloader/scoping/singleton"/>
      <copy tofile="${build.gen-src}/org/jboss/test/classloader/scoping/singleton/MySingleton.java"
            file="${source.java}/org/jboss/test/classloader/scoping/singleton/MySingleton_V1.txt" overwrite="false"/>
   </target>

   <!-- retrieve items from the repository, store them in the -->
   <!-- thirdparty folder, and create a testsuite-libraries.ent file -->
   <!-- then generate a new libraries.ent file and include it in  -->
   <!-- the build                                                 -->
   <target name="createthirdparty" unless="inhibit.downloads"
      depends="check.inhibit.downloads, set.proxy">
      <condition property="mvn.cmd" value="mvn.bat" else="mvn">
         <os family="windows"/>
      </condition>
      <exec executable="${mvn.cmd}" dir="../thirdparty">
        <arg line="package"/>
      </exec>
   </target>

   <!-- check if thirdparty libraries are to be downloaded -->
   <target name="check.inhibit.downloads">
      <condition property="inhibit.downloads">
         <or>
            <uptodate property="dependencies.current"
	          srcfile="../pom.xml"
               targetfile="../thirdparty/testsuite-libraries.ent"/>
            <istrue value="${nodownload}"/>
         </or>
      </condition>
  </target>

  <!-- check if the the user has specied proxy settings -->
  <target name="check.proxy">
    <condition property="hasproxy">
        <and>
            <isset property="proxy.host"/>
            <isset property="proxy.port"/>
            <not>
                <equals arg1="" arg2="${proxy.host}" trim="true"/>
            </not>
            <not>
                <equals arg1="" arg2="${proxy.port}" trim="true"/>
            </not>
        </and>
    </condition>
  </target>

  <!-- set proxy settings -->
  <target name="set.proxy" if="hasproxy" depends="check.proxy">
    <echo>Proxy is set to ${proxy.host}:${proxy.port}</echo>
    <setproxy proxyhost="${proxy.host}" proxyport="${proxy.port}"/>
  </target>

   <!-- ================================================================== -->
   <!-- Compile                                                            -->
   <!-- ================================================================== -->
   <import file="imports/code-generation.xml"/>

   <!--
      |  Compile everything.
      |
      |  This target should depend on other compile-* targets for each
      |  different type of compile that needs to be performed, short of
      |  documentation compiles.
     -->
   <target name="compile"
      depends="init, compile-classes, compile-xmbean-dds, compile-stubs, compile-etc, compile-stylesheets, compile-resources"
      description="Compile all source files."/>

   <!-- Compile all class files -->
   <target name="compile-classes" depends="compile-bean-sources, compile-mbean-sources, compile-proxycompiler-bean-sources, compile-classes-only">
   </target>

   <target name="compile-annotated-classes-50" if="HAVE_JDK_1.5">
     <mkdir dir="${build.classes}"/>

     <javac destdir="${build.classes}"
       optimize="${javac.optimize}"
       source="1.5"
       target="1.5"
       debug="${javac.debug}"
       depend="${javac.depend}"
       verbose="${javac.verbose}"
       deprecation="${javac.deprecation}"
       includeAntRuntime="${javac.include.ant.runtime}"
       includeJavaRuntime="${javac.include.java.runtime}"
       failonerror="${javac.fail.onerror}">
       <src path="${source.java.5}"/>
       <classpath refid="tests.compile.classpath"/>
         <include name="org/jboss/test/aop/**"/>
     </javac>

      <!-- The aop tests use JDK 5 annotations, so make sure that the jboss-aop-jdk50.jar comes before the JDK1.4 style annotations defined in jboss-messaging-client.jar  -->
      <path id="annotations.classpath">
         <path refid="jboss.aop.classpath"/>
         <path refid="tests.compile.classpath"/>
      </path>

     <javac destdir="${build.classes}"
       optimize="${javac.optimize}"
       source="1.5"
       target="1.5"
       debug="${javac.debug}"
       depend="${javac.depend}"
       verbose="${javac.verbose}"
       deprecation="${javac.deprecation}"
       includeAntRuntime="${javac.include.ant.runtime}"
       includeJavaRuntime="${javac.include.java.runtime}"
       failonerror="${javac.fail.onerror}">
       <src path="${source.java}"/>
       <classpath refid="annotations.classpath"/>
         <include name="org/jboss/test/aop/**"/>
     </javac>

   </target>

   <target name="compile-classes-only" depends="compile-annotated-classes-50,compile-jacorb-stubs">
      <mkdir dir="${build.classes}"/>
      <javac destdir="${build.classes}"
         optimize="${javac.optimize}"
         source="${javac.source}"
         target="${javac.target}"
         debug="${javac.debug}"
         depend="${javac.depend}"
         verbose="${javac.verbose}"
         deprecation="${javac.deprecation}"
         includeAntRuntime="${javac.include.ant.runtime}"
         includeJavaRuntime="${javac.include.java.runtime}"
         failonerror="${javac.fail.onerror}">
         <src path="${source.java}"/>
         <src path="${build.gen-src}"/>
         <exclude name="org/jboss/test/recover/oracle/**"/>
         <exclude name="org/jboss/test/recover/derby/**"/>
         <exclude name="org/jboss/test/xml/JaxpXPathBaseTestCase*" if="HAVE_JDK_1.4"/>
         <exclude name="org/jboss/test/aop/**"/>
         <classpath refid="tests.compile.classpath"/>
      </javac>
   </target>

   <target name="compile-stubs">
      <rmic base="${build.classes}"
         sourcebase="${build.classes}"
         verify="${rmic.verify}"
         iiop="${rmic.iiop}"
         iiopopts="${rmic.iiopopts}"
         idl="${rmic.idl}"
         idlopts="${rmic.idlops}"
         debug="${rmic.debug}"
         stubVersion="${rmic.stubVersion}"
         >
         <classpath refid="tests.compile.classpath"/>
         <patternset refid="rmic.includes" />
      </rmic>      
   </target>
   
   <target name="compile-jacorb-stubs">
      <!-- Create JacORB-based Stubs for JBPAPP-6462 -->
      <taskdef name="jacidl" classname="org.jacorb.idl.JacIDL">
	<classpath>
	    <pathelement location="../thirdparty/jacorb/lib/idl.jar"/>
	    <pathelement location="../thirdparty/apache-avalon-logkit/lib/logkit.jar"/>
        </classpath>
      </taskdef>

      <jacidl srcdir="${source.java}/org/jboss/test/iiop/jbpapp6462/idl"
              destdir="${source.java}"
              includes="jbpapp6462.idl"
              all="true">
	<i2jpackage names=":org.jboss.test.iiop.jbpapp6462.generated"/>
      </jacidl>
   </target>

   <!-- Compile resource files -->
   <target name="compile-resources">
      <mkdir dir="${build.resources}"/>
      <copy todir="${build.resources}" filtering="no">
         <fileset dir="${source.resources}">
            <exclude name="webservice/**"/>
         	<exclude name="pooled/**"/>
         	<exclude name="jrmp/service-inf/**"/>
            <include name="**/*"/>
         </fileset>
      </copy>
   	  <condition property="java.is.ibm">
   	      <contains string="${java.vendor}" substring="IBM" casesensitive="false" />
   	  </condition>
   	  <antcall target="compile-resources-ibm"/>
   	  <antcall target="compile-resources-no-ibm"/>
   </target>
   	    
   <target name="compile-resources-ibm" if="java.is.ibm">
      <copy todir="${build.resources}" filtering="true">
      	<filterset>
      		<filter token="PROTOCOLS" value="SSLv3,TLSv1"/>
      	</filterset>
         <fileset dir="${source.resources}">
            <include name="pooled/**"/>
            <include name="jrmp/service-inf/**"/>
         </fileset>
      </copy>
   </target>
   	    
   <target name="compile-resources-no-ibm" unless="java.is.ibm">
      <copy todir="${build.resources}" filtering="true">
      	 <filterset>
      	 	<filter token="PROTOCOLS" value="SSLv2Hello,SSLv3,TLSv1"/>
      	 </filterset>
         <fileset dir="${source.resources}">
            <include name="pooled/**"/>
            <include name="jrmp/service-inf/**"/>
         </fileset>
   	  </copy>
    </target>

   <!-- Compile stylesheets files -->
   <target name="compile-stylesheets">
      <mkdir dir="${build.stylesheets}"/>
      <copy todir="${build.stylesheets}" filtering="yes">
         <fileset dir="${source.stylesheets}">
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>

   <!-- Compile etc files (manifests and such) -->
   <target name="compile-etc">
      <mkdir dir="${build.etc}"/>
      <copy todir="${build.etc}" filtering="yes">
         <fileset dir="${source.etc}">
            <include name="**/*"/>
         </fileset>
      </copy>
   </target>


   <!-- Import the test jars build targets -->
   <import file="imports/test-jars.xml"/>

   <!-- Propagate the dist directory as a jbosstest system property -->
   <property name="jbosstest.dist" value="${jboss.dist}"/>

   <!-- ================================================================== -->
   <!-- Cleaning                                                           -->
   <!-- ================================================================== -->

   <!-- Clean up all build output -->
   <target name="clean" depends="_default:clean"
      description="Cleans up most generated files."/>

   <!-- Clean up all build output -->
   <target name="clobber" depends="_default:clobber"
     description="Cleans up all generated files.">
   </target>

   <!-- ================================================================== -->
   <!-- Misc.                                                              -->
   <!-- ================================================================== -->

   <target name="main"
      description="Executes the default target (most)."
      depends="createthirdparty,most"/>

   <target name="all"
      description="Builds everything."
      depends="jars"/>

   <target name="most"
      description="Builds almost everything."
      depends="jars"/>

   <target name="help" description="Displays the project help">
      <echo>
         The main targets are:
         + jars : compile the tests and build the test jars
         + tests : the main tests entry points which runs all normal unit tests
         Use ant -projecthelp to list all documented targets.
      </echo>
   </target>
   
   <!-- Unsigns all jars (rars, wars, ears) in JBoss AS located in ${jboss.dist},
	original JBoss AS with signed jars (rars, wars, ears) is moved to ${jboss.dist}.signed.
	Property unsign.supressBackup="true", disables backup of original signed JBoss AS. -->
   <target name="unsign" description="Unsigns all jars in current JBoss AS.">
     <taskdef resource="net/sf/antcontrib/antlib.xml"
       classpath="${project.tools}/lib/ant-contrib-1.0b3.jar"/>  <!-- ant-contrib jar location -->
     <property name="sf" value="JBOSSCOD.SF"/>
     <property name="rsa" value="JBOSSCOD.RSA"/>
 
    <!-- Check if backup is needed -->
    <if>
      <not>
	<equals arg1="${unsign.supressBackup}" arg2="true" />
      </not>
      <then>
	<copy toDir="${jboss.dist}.signed">
	  <fileSet dir="${jboss.dist}"/>
	</copy>
      </then>
    </if>

     <for param="file">
       <path>
	 <fileset dir="${jboss.dist}">
	   <include name="**/*.jar"/>
	   <include name="**/*.rar"/>
	   <include name="**/*.war"/>
	   <include name="**/*.ear"/>
	 </fileset>
       </path>
       <sequential>
	   <jar destfile="@{file}-unsigned">
	      <zipfileset src="@{file}">
		<exclude name="**/*${sf}"/>
		<exclude name="**/*${rsa}"/>
	      </zipfileset>
	    </jar>
	  <delete file="@{file}"/>
	  <move file="@{file}-unsigned" tofile="@{file}"/> 
       </sequential>
     </for>

   </target>
   

   <!-- ================================================================== -->
   <!-- Tests                                                              -->
   <!-- ================================================================== -->

   <macrodef name="wait-on-host">
      <attribute name="seconds" default="240"/>
      <attribute name="host" default="${node0}"/>
      <sequential>
         <echo message="Waiting for @{host} to start..."/>
         <waitfor maxwait="@{seconds}" maxwaitunit="second"
            checkevery="5" checkeveryunit="second" timeoutproperty="startup.timeout">
            <http url="http://@{host}:8080/"/>
         </waitfor>
         <fail message="Timeout waiting for nodes to start" if="startup.timeout"/>
      </sequential>
   </macrodef>

   <macrodef name="wait-on-shutdown">
      <attribute name="seconds" default="240"/>
      <attribute name="conf"/>
      <attribute name="serverlog" default="${jboss.dist}/server/@{conf}/log/server.log"/>
      <sequential>
         <echo message="Waiting for '@{conf}' server to stop..."/>
         <waitfor maxwait="@{seconds}" maxwaitunit="second"
            checkevery="5" checkeveryunit="second" timeoutproperty="shutdown.timeout">
            <available file="@{serverlog}">
               <filepath>
                  <fileset dir="${jboss.dist}/server/@{conf}/log/" includes="server.log">
                     <contains text="[org.jboss.bootstrap.microcontainer.ServerImpl] (JBoss Shutdown Hook) Shutdown complete"/>
                  </fileset>
               </filepath>
            </available>
         </waitfor>
         <fail message="Timeout waiting for '@{conf}' server to shutdown." if="shutdown.timeout"/>
      </sequential>
   </macrodef>

   <!-- patternsets for specialized configs -->
   
   <!-- Make the "test" system property a patternset -->
   <patternset id="one.test.includes">
      <include name="${test}"/>
   </patternset>
   <patternset id="binding-manager.includes">
     <include name="org/jboss/test/binding/*TestCase.class"/>
   </patternset>
   <patternset id="binding-manager.excludes">
     <exclude name="org/jboss/test/binding/*TestCase.class"/>
   </patternset>
   <!-- The compatibility tests need extra memory -->
   <patternset id="compatibility.includes">
     <include name="org/jboss/test/compatibility/test/*TestCase.class"/>
   </patternset>
   <patternset id="compatibility.excludes">
     <exclude name="org/jboss/test/compatibility/test/*TestCase.class"/>
   </patternset>
   <!-- Tests needing deployment service setup -->
   <patternset id="deployment-service.includes">
      <include name="org/jboss/test/deployment/test/*TestCase.class"/>
   </patternset>
   <patternset id="deployment-service.excludes">
      <exclude name="org/jboss/test/deployment/test/*TestCase.class"/>
   </patternset>
   <!-- Tests needing IIOP setup -->
   <patternset id="iiop.includes">
      <include name="org/jboss/test/*iiop/test/*TestCase.class"/>
      <include name="org/jboss/test/ejb3/*iiop/unit/*TestCase.class"/>
      <exclude name="org/jboss/test/txiiop/test/*TestCase.class"/>
   </patternset>
   <patternset id="iiop.excludes">
      <exclude name="org/jboss/test/*iiop/test/*"/>
      <exclude name="org/jboss/test/ejb3/*iiop/unit/*"/>
   </patternset>
   <!-- A patternset that requires jboss to run with a JACC security manager -->
   <patternset id="jacc.includes">
      <include name="**/test/jacc/test/*TestCase.class"/>
      <include name="org/jboss/test/web/test/UserInRoleUnitTestCase.class" />
      <include name="org/jboss/test/cmp2/audit/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/commerce/*TestCase.class" />
      <include name="org/jboss/test/cmp2/cmrstress/*TestCase.class" />
      <include name="org/jboss/test/cmp2/cmrtransaction/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/perf/test/*TestCase.class" />
      <include name="org/jboss/test/cmp2/relationship/*TestCase.class" />
      <include name="org/jboss/test/cmp2/simple/SimpleUnitTestCase.class" />
      <include name="**/test/webservice/jbws309/*TestCase.class"/>
   </patternset>
   <patternset id="jacc.excludes">
	<exclude name="**/test/jacc/test/*"/>
   </patternset>
   <patternset id="jacc.allstarrole.includes">
      <include name="org/jboss/test/jacc/test/allstarrole/*TestCase.class"/>
   </patternset>

   <patternset id="ldap.includes">
      <include name="**/test/security/test/opends/*TestCase.class"/>
   </patternset>
   <patternset id="jaxr.includes">
      <include name="org/jboss/test/jaxr/scout/**/*TestCase.class"/>
      <exclude name="org/jboss/test/jaxr/scout/**/Jaxr*Association*TestCase.class"/>
   </patternset>
   <!-- jbossmessaging includes -->
   <patternset id="jbossmessaging.includes">
    <include name="org/jboss/test/jbossmessaging/**/Jms11UnitTest.class"/>
     <include name="org/jboss/test/jbossmessaging/test/*UnitTestCase.class"/>
     <include name="org/jboss/test/jbossmessaging/perf/*StressTestCase.class"/>
     <include name="org/jboss/test/jbossmessaging/ra/*UnitTestCase.class"/>
     <include name="org/jboss/test/jms/integration/**/*Test.class"/>
   </patternset>
   <patternset id="jbossmessaging-clustering.includes">
     <include name="org/jboss/test/jbossmessaging/clustertest/*TestCase.class"/>
   </patternset>
   <!-- jbossmessaging excludes -->
   <patternset id="jbossmessaging.excludes">
     <exclude name="org/jboss/test/jbossmessaging/test/*UnitTestCase.class"/>
     <exclude name="org/jboss/test/jbossmessaging/perf/*StressTestCase.class"/>
     <exclude name="org/jboss/test/jbossmessaging/ra/*UnitTestCase.class"/>
     <exclude name="org/jboss/test/jms/integration/**/*Test.class"/>
   </patternset>
   <!-- Tests needing xml binding setup -->
   <patternset id="jbossxb.includes">
      <include name="org/jboss/test/xml/*TestCase.class"/>
   </patternset>
   <patternset id="jbossxb.excludes">
   </patternset>
   <!-- Tests needing jrmp invoker -->
   <patternset id="jrmp-invoker.includes">
      <include name="org/jboss/test/cts/test/BmpUnitTestCase.class" unless="build.ewp"/>
      <!--include name="org/jboss/test/cts/test/ClientCallbackImpl.class"/-->
      <include name="org/jboss/test/cts/test/CmpUnitTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/CtsCmp2UnitTestCase.class"/>
      <include name="org/jboss/test/cts/test/IndependentJarsUnitTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/LocalEjbTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/LongWaitStatefulSessionUnitTestCase.class" unless="build.ewp"/>
      <!--include name="org/jboss/test/cts/test/MDBInvoker.class"/-->
      <!--include name="org/jboss/test/cts/test/MDBUnitTestCase.class"/-->
      <!--include name="org/jboss/test/cts/test/SessionInvoker.class"/-->
      <include name="org/jboss/test/cts/test/StatefulSessionLocalUnitTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/StatefulSessionUnitTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/StatelessSessionStressTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/cts/test/StatelessSessionUnitTestCase.class" unless="build.ewp"/>
      <include name="org/jboss/test/bank/test/BankEJB20StressTestCase.class"/>
      <include name="org/jboss/test/testbean/test/BeanUnitTestCase.class"/>
    </patternset>
    <patternset id="jrmp-invoker.excludes">
       <exclude name="org/jboss/test/bank/test/*"/>
    </patternset>
   <!-- A patternset for that require a security config -->
   <patternset id="security.includes">
      <include name="**/test/naming/test/Security*"/>
      <include name="**/test/security/test/*UnitTestCase.class"/>
      <include name="**/test/security/test/auth/*UnitTestCase.class"/>
      <include name="**/test/security/test/authorization/*UnitTestCase.class"/>
      <include name="**/test/security/test/mapping/**/*TestCase.class"/>
      <include name="**/test/web/security/authorization/XACML*UnitTestCase.class"/>
      <include name="**/test/jca/test/SecurityContextUnitTestCase.class"/>
      <include name="**/test/jmx/test/Secure*TestCase.class"/>
      <include name="**/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
      <include name="**/test/perf/test/SecurePerfStressTestCase.class"/>
      <include name="**/test/timer/test/SecureTimerUnitTestCase.class" unless="build.ewp"/>
      <include name="**/test/security/test/client/*UnitTestCase.class"/>
   </patternset>
   <patternset id="security.excludes">
      <exclude name="**/test/naming/test/Security*"/>
      <exclude name="**/test/security/test/*UnitTestCase.class"/>
      <exclude name="**/test/security/test/authorization/*UnitTestCase.class"/>
      <exclude name="**/test/jca/test/SecurityContextUnitTestCase.class"/>
      <exclude name="**/test/jmx/test/Secure*"/>
      <include name="**/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingFromSARUnitTestCase.class"/>
      <exclude name="**/test/jrmp/test/DynLoadingFromSARUnpackedUnitTestCase.class"/>
      <exclude name="**/test/perf/test/SecurePerfStressTestCase.class"/>
      <exclude name="**/test/timer/test/SecureTimerUnitTestCase.class" unless="build.ewp"/>
      <exclude name="**/test/web/security/authorization/XACMLWeb*.class"/>
      <exclude name="**/test/security/test/client/*UnitTestCase.class"/>
      <exclude name="**/test/profileservice/testsecure/*UnitTestCase.class"/>
      <exclude name="**/test/passwordinjection/test/*UnitTestCase.class"/>
      <exclude name="**/test/security/test/authorization/secured/*.class"/>
   </patternset>
   <!-- A patternset required for Common Criteria certification: note this is never used ... -->
   <patternset id="cc.includes">
      <include name="**/test/tm/test/TxTimeout*TestCase.class"/>
      <include name="**/test/security/rmi/test/*TestCase.class"/>
      <include name="org/jboss/test/security/test/CallerInfoUnitTestCase.class"/>
      <include name="org.jboss.test.deployers.web.test.WEBDeploymentUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/SubjectContextUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/DeepCopySubjectUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/EJB3SpecUnitTestCase.class"/>
      <include name="org/jboss/test/ejb3/jbpapp2473/unit/RunAsUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/EJBSpecUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/LoginContextUnitTestCas.class"/>
      <include name="org/jboss/test/security/test/NamespacePermissionsUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/PermissionNameUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/WebConstraintsUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/WebResourcePermissionUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/WebUserDataPermissionUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/auth.AppCallbackHandlerUnitTestCase.class"/>
      <include name="org/jboss/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
      <include name="org/jboss/test/jmx/test/RMIAdaptorUnitTestCase.class"/>
      <include name="org/jboss/test/jbossmx/compliance/registration/MXBeanRegistrationTestCase.java"/>
      <include name="org/jboss/test/web/test/ssl/SSLUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/ClientLoginModuleEJBUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/ClientLoginModuleUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/CustomPrincipalPropagationUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/DynamicLoginConfigServiceUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/EJBPermissionUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/JaasSecurityDomainUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/LoginModulesUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/MissingMethodUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/RoleMappingModuleUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/SAInheritableThreadLocalUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/SAThreadLocalUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/SecurityDomainLoginModuleOptionUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/SecurityMgrStressTestCase.class"/>
      <include name="org/jboss/test/security/test/SecurityProxyUnitTestCase.class"/>
      <include name="org/jboss/test/security/test/XMLLoginModulesUnitTestCase.class"/>
      <include name="org/jboss/test/securitymgr/test/PolicyUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/WebIntegrationUnitTestCase.class"/>
      <include name="org/jboss/test/web/security/CustomHeaderAuthTestCase.class"/>
      <include name="org/jboss/test/web/test/FormAuthUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/UserInRoleUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
      <include name="org/jboss/test/jmx/test/SecureRMIAdaptorUnitTestCase.class"/>
      <include name="org/jboss/test/security/rmi/test/RMIOverHttpsTestCase.class"/>
      <include name="org/jboss/test/naming/test/SecurityUnitTestCase.class"/>
      <include name="org/jboss/test/aop/test/SecurityUnitTestCase.class"/>
      <include name="org/jboss/test/jbossts/ASCrashRecovery01/TestWithJPA.class"/>
      <include name="org/jboss/test/jbossts/ASCrashRecovery01/WipeOutTxsInDoubt.class"/>
      <include name="org/jboss/test/jbossts/ASCrashRecovery02/TestWithJMS.class"/>
      <include name="org/jboss/test/tm/test/TxTimeoutAnnotUnitTestCase.class"/>
      <include name="org/jboss/test/invokers/test/MultiInvokersUnitTestCase.class"/>
      <include name="org/jboss/test/cluster/defaultcfg/test/HAInvokerUnitTestCase.class"/>
      <include name="org/jboss/test/ws/jaxws/ejb3Integration/injection/InjectionTestCase.class"/>
   </patternset>
   <!-- pattern set for cc-audit configuration -->
   <patternset id="cc-audit.includes">
      <include name="org/jboss/test/scripts/test/ShutdownTestCase.class"/>
      <include name="org/jboss/test/scripts/test/RunTestCase.class"/>
   </patternset>
   <!-- A patternset that requires jboss to run with a security manager -->
   <patternset id="securitymgr.includes">
      <include name="**/test/securitymgr/test/*TestCase.class"/>
   </patternset>
   <patternset id="securitymgr.excludes">
      <exclude name="**/test/securitymgr/test/*"/>
   </patternset>
	<!-- Patternset for the JSR-196 based unit tests -->
    <patternset id="security.jaspi.includes">
      <include name="**/test/security/container/auth/**/*TestCase.class"/>
      <include name="**/test/security/managers/**/*TestCase.class"/>
      <include name="org/jboss/test/web/security/authorization/*TestCase.class"/>
      <include name="org/jboss/test/web/test/JASPIFormAuthUnitTestCase.class"/>
   </patternset>
   <patternset id="stax.include">
      <include name="org/jboss/test/stax/**/*TestCase.class"/>
   </patternset>
   <!-- Tests needing non-clustered tomcat SSO -->
   <patternset id="tc-sso.includes">
      <include name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
      <include name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
   </patternset>
   <patternset id="tc-sso.excludes">
      <exclude name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
      <exclude name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
   </patternset>
   <!-- Tests needing clustered tomcat SSO -->
   <patternset id="tc-sso-clustered.includes">
      <include name="org/jboss/test/web/test/ClusteredSingleSignOnUnitTestCase.class"/>
   </patternset>
   <patternset id="tc-sso-clustered.excludes">
      <exclude name="org/jboss/test/web/test/ClusteredSingleSignOnUnitTestCase.class"/>
   </patternset>
   <!-- Tests needing tomcat federation -->
   <patternset id="tc-federation.includes">
      <include name="org/jboss/test/web/security/*TestCase.class"/>
      <include name="org/jboss/test/web/test/FormAuthUnitTestCase.class"/>
      <exclude name="org/jboss/test/web/security/GenericHeaderAuthUnitTestCase.class"/>
   </patternset>
   <!-- Tests needing tomcat SSL -->
   <patternset id="tc-ssl.includes">
      <include name="org/jboss/test/web/test/ssl/*TestCase.class"/>
   </patternset>
   <patternset id="tc-ssl.excludes">
      <exclude name="org/jboss/test/web/test/ssl/*"/>
   </patternset>
   <!-- Tests needing tomcat WebCtxLoader set via the UseJBossWebLoader setting -->
   <patternset id="tomcat.webctx.includes">
      <include name="org/jboss/test/web/test/WebCtxLoaderTestCase.class"/>
   	  <include name="org/jboss/test/web/test/VirtualHostTestCase.class"/>
   </patternset>
   <!-- ws-bpel integration tests -->
   <patternset id="jbpm-bpel.includes">
     <include name="org/jboss/test/bpel/**/*TestCase.class"/>
   </patternset>
   <patternset id="jbpm-bpel.excludes">
     <exclude name="org/jboss/test/bpel/**/*TestCase.class"/>
   </patternset>
  <!-- Classloader Leak Tests -->
  <patternset id="classloader-leak.includes">
    <include name="org/jboss/test/classloader/leak/test/*TestCase.class"/>
  </patternset>
  <patternset id="classloader-leak.excludes">
    <exclude name="org/jboss/test/classloader/leak/test/*TestCase.class"/>
  </patternset>
  <patternset id="profileservice.includes">
    <include name="org/jboss/test/profileservice/test/*TestCase.class"/>
  	<include name="org/jboss/test/profileservice/override/test/*TestCase.class"/>
    <!-- deployers + seam -->
  	<include name="org/jboss/test/deployers/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/client/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/ear/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/ejb/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/rar/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/sar/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/web/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/jbas2904/test/*UnitTestCase.class"/>
    <include name="org/jboss/test/deployers/seam/test/SeamDvdstoreExampleUnitTestCase.class"/>
    <include name="org/jboss/test/deployers/seam/test/SeamNumberguessExampleUnitTestCase.class"/>
    <include name="org/jboss/test/deployers/seam/test/SeamVFSClassloadingUnitTestCase.class"/>
  </patternset>
  <patternset id="profileservice.excludes">
    <exclude name="org/jboss/test/profileservice/test/*TestCase.class"/>
  	<exclude  name="org/jboss/test/profileservice/override/test/*TestCase.class"/>
    <!-- deployers + seam -->
  	<exclude name="org/jboss/test/deployers/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/client/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/ear/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/ejb/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/rar/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/sar/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/web/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/jbas2904/test/*UnitTestCase.class"/>
    <exclude name="org/jboss/test/deployers/seam/test/*UnitTestCase.class"/>
  </patternset>
  <patternset id="profileservice.restart.includes">
    <!-- include target for persisted admin changes -->
    <include name="org/jboss/test/profileservice/override/restart/test/*TestCase.class"/>
  </patternset>
  <patternset id="profileservice.restart.excludes">
	<exclude name="org/jboss/test/profileservice/override/restart/test/*TestCase.class"/>
  </patternset>
  <patternset id="springdeployer.includes">
    <include name="org/jboss/test/spring/test/SpringClusterTestCase.class" unless="build.ewp"/>
    <include name="org/jboss/test/spring/test/SpringEJBTestCase.class"/>
    <include name="org/jboss/test/spring/test/SpringFacadeTestCase.class"/>
    <include name="org/jboss/test/spring/test/SpringStandaloneTestCase.class"/>
  </patternset>
  <patternset id="springdeployer.excludes">
    <exclude name="org/jboss/test/spring/test/*TestCase.class"/>
  </patternset>

   <!-- Remove tests known to not work with EWP -->
   <patternset id="ewp.excludes">
      <!-- Don't forget the  if="build.ewp" ! -->

      <!-- EWP doesn't ships JMS -->
      <exclude name="org/jboss/test/client/test/AppClientUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/BmpUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/CmpUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/CtsCmp2OptionDUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/IndependentJarsUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/LongWaitStatefulSessionUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/MDBUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/StatefulSessionLocalUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/StatefulSessionUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/StatelessSessionBrokenCreateUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/StatelessSessionStressTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cts/test/StatelessSessionUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/ee5client/unit/AppClientUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/ejb3/jbas6239/unit/RunAsMDBUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/ejb/lifecycle/test/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/invokers/test/MultiInvokersUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jacc/test/EJBSpecUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jacc/test/WebIntegrationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jbossmessaging/**/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jca/test/ExecuteJMSDuringRollbackStressTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jca/test/TransactionActiveUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jms/**/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jmsra/**/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/jmx/test/RedeployStressTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/mdbsessionpoolclear/test/MDBUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/mdb/test/MDBUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/messagedriven/**/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/naming/test/ENCUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/naming/test/NamingStressTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/override/restart/test/JmsDestinationRestartUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/override/test/ConnectionFactoryOverrideTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/override/test/JmsDestinationOverrideTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/test/ConnectionFactoryUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/test/Ejb3MetricsUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/profileservice/test/JmsDestinationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/refs/test/ResourceResolutionUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/security/test/client/SecurityClientUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/security/test/EJBSpecUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/timer/test/*.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/test/EncAnnotationsUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/test/EncXmlUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/test/JSFInjectionUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/test/JSPAnnotationENCUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/test/WebIntegrationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/web/jbas8318/unit/ResourceInjectionOnNonJavaEEComponentsTestCase.class" if="build.ewp"/>

      <!-- EWP doesn't ships bsh.jar -->
      <exclude name="org/jboss/test/deployers/seam/test/SeamDvdstoreExampleUnitTestCase.class" if="build.ewp"/>

      <!-- EWP doesn't ships management console (console-mgr.sar) -->
      <exclude name="org/jboss/test/console/jbas3861/*.class" if="build.ewp"/>

      <!-- Depends on lots of things which aren't shipped with EWP, like jms-ra.rar, jmx-remoting.sar, jsr88-service.xml -->
      <exclude name="org/jboss/test/profileservice/test/ProfileServiceUnitTestCase.class" if="build.ewp"/>

      <!-- Missing uuid-key-generator.sar -->
      <exclude name="org/jboss/test/cmp2/optimisticlock/test/OptimisticLockUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cmp2/passivation/test/EntityPassivationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cmp2/keygen/test/KeyGenerationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cmp2/fkmapping/test/FKMappingUnitTestCase.class" if="build.ewp"/>

      <!-- Uses InvalidationManager, not available in EWP -->
      <exclude name="org/jboss/test/cluster/multicfg/ejb2/test/CacheInvalidationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cluster/multicfg/ejb2/test/StatefulPassivationExpirationUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cluster/defaultcfg/test/PartitionRestartUnitTestCase.class" if="build.ewp"/>
      <exclude name="org/jboss/test/cmp2/cacheinvalidation/test/CacheInvalidationUnitTestCase.class" if="build.ewp"/>

      <!-- HTTP invokers -->
      <exclude name="org/jboss/test/hello/test/*.class" if="build.ewp"/>
   </patternset>

   <!-- Tests that are currently broken -->
   <patternset id="badtest.excludes">
      <exclude name="org/jboss/test/aop/test/RemotingUnitTestCase"/>
   	        
      <!-- Needs apache ? -->
      <exclude name="org/jboss/test/cluster/httpsessionreplication/**" />
      <exclude name="org/jboss/test/cache/test/local/ConcurrentTransactionalUnitTestCase.class" />
      <!-- JBAS-2026 -->
      <exclude name="org/jboss/test/jmx/test/JarInSarJSR77UnitTestCase.class"/>
      <!-- Tests invoking JBossCache via MBean interface, which is no longer supported -->
      <exclude name="org/jboss/test/cluster/defaultcfg/cache/test/*"/> 
      <!-- JBAS-4548 -->
      <exclude name="org/jboss/test/deployers/ear/test/EmbeddedDatasourceUnitTestCase.class"/>
     	<!-- Test of old farming implementation -->
      <exclude name="org/jboss/test/cluster/multicfg/test/ClusterFileTransferTestCase.class"/>
    	<!-- Unfinished test of clustered deployment via profile service -->
      <exclude name="org/jboss/test/cluster/defaultcfg/profileservice/test/ClusteredDeployUnitTestCase.class"/>
      <!-- JASPI needs revisiting -->
      <exclude name="org/jboss/test/web/test/JASPIFormAuthUnitTestCase.class"/>
    	<!-- New diagnostic test that has transient failures; needs further work -->
    	<exclude name="org/jboss/test/cluster/defaultcfg/simpleweb/test/ClusteredSessionMemoryLeakTestCase.class"/>
   	
   	  <!-- Exclude some classloader leak tests on Sun VM only; they should run on JRockit, OpenJDK -->
    	<exclude name="org/jboss/test/classloader/leak/test/AopPreparedClassesClassloaderLeakUnitTestCase.class" if="sun-vm"/>
    	<exclude name="org/jboss/test/cluster/classloader/leak/test/*Field*TestCase.class" if="sun-vm"/>
   
      <!-- JBAS-6582, http://lists.jboss.org/pipermail/jboss-development/2008-December/013254.html -->
      <exclude name="org/jboss/test/ejb3/servlet/unit/ServletUnitTestCase.class"/>

      <exclude name="org/jboss/test/jbossmessaging/test/UnackedUnitTestCase.class"/>
      <exclude name="org/jboss/test/ejb3/jbpapp2260/unit/MessageInflowTransactionUnitTestCase.class"/>
      

   	  <!-- JBAS-6792 fix temporarily reverted -->
      <!--exclude name="org/jboss/test/cluster/defaultcfg/test/HAServiceUnitTestCase.class"/>
      <exclude name="org/jboss/test/cluster/defaultcfg/test/HASingletonUnitTestCase.class"/-->

      <!-- jmx-remoting.sar is now disabled for security reasons -->
      <exclude name="org/jboss/test/jmx/test/JMXConnectorUnitTestCase.class"/>
     
      <!-- JBPAPP-4719 - This functionality was excluded by default for security reasons -->
      <exclude name="org/jboss/test/console/jbas3861/**"/> 
      <!-- if we are testing EWP, we need to exclude some tests -->
      <patternset refid="ewp.excludes"/>
   </patternset>

   <patternset id="aop-with-classloader.excludes">
      <!-- Needs to be started either with the bootclasspath or -javaagent classloader hooks -->
      <exclude name="org/jboss/test/aop/test/Scoped*.class"/>
   </patternset>
   <patternset id="aop-with-classloader.includes">
      <include name="org/jboss/test/aop/test/Scoped*TestCase.class"/>
   </patternset>

   <!-- The union of the excludes -->
   <patternset id="all.excludes">
      <patternset refid="aop-with-classloader.excludes"/>
      <patternset refid="badtest.excludes"/>
      <patternset refid="classloader-leak.excludes"/>
      <patternset refid="bootstrap-dependencies.excludes"/>
      <patternset refid="cluster.excludes"/>
      <patternset refid="security.excludes"/>
      <patternset refid="securitymgr.excludes"/>
      <patternset refid="jacc.excludes"/>
      <patternset refid="tc-sso.excludes"/>
      <patternset refid="tc-sso-clustered.excludes"/>
      <patternset refid="tc-ssl.excludes"/>
      <patternset refid="iiop.excludes"/>
      <patternset refid="jbossxb.excludes"/>
      <patternset refid="deployment-service.excludes"/>
      <patternset refid="compatibility.excludes"/>
      <patternset refid="binding-manager.excludes"/>
      <patternset refid="profileservice.excludes"/>
      <patternset refid="profileservice.restart.excludes"/>
      <patternset refid="jbossmessaging.excludes"/>
      <patternset refid="springdeployer.excludes"/>
   </patternset>   
	
	<!-- A placeholder patternset -->
	<patternset id="empty.patternset"/>

	<!-- Tests to exclude when we run on EC2 -->
	<patternset id="ec2.excludes">
	  <!-- These tests involve multicast-based HA-JNDI auto-discovery -->
	  <exclude name="org/jboss/test/naming/test/NamingRestartAutoDiscoveryUnitTestCase.class"/>
	  <exclude name="org/jboss/test/naming/test/HAJndiAutoDiscoveryTestCase.class"/>
          <exclude name="org/jboss/test/cluster/defaultcfg/ejb2/test/RetryInterceptorAutoDiscoveryUnitTestCase.class"/>
          <exclude name="org/jboss/test/cluster/defaultcfg/ejb2/test/SingleRetryInterceptorAutoDiscoveryUnitTestCase.class"/>
          <exclude name="org/jboss/test/cluster/multicfg/test/HAJndiAutoDiscoveryTestCase.class"/>
          <exclude name="org/jboss/test/cluster/multicfg/test/GlobalDiscoveryDisableTestCase.class"/>
          <!-- These programatically create UDP-based channels -->
          <exclude name="org/jboss/test/cluster/defaultcfg/simpleweb/test/*TestCase.class"/>
          <!-- These tests depend on DownloadServerClasses=true which is currently false -->
          <exclude name="org/jboss/test/jrmp/test/DynLoadingFromSARUnitTestCase.class"/>
          <exclude name="org/jboss/test/jrmp/test/DynLoadingFromSARUnpackedUnitTestCase.class"/>
          <exclude name="org/jboss/test/jrmp/test/DynLoadingUnitTestCase.class"/>
          <!-- This test expects a session bean call that leaks a db connection to result in a remote exception.  That is a debug feature that is disabled  -->
          <exclude name="org/jboss/test/jca/test/CachedConnectionErrorUnitTestCase.class"/>
          <!-- The HttpsUnitTestCase unreasonably expects to change the SSL keystore using system properties like javax.net.ssl.trustStore  -->
          <exclude name="org/jboss/test/security/test/HttpsUnitTestCase.class"/>
          <patternset refid="badtest.excludes"/>
	</patternset>

   <!-- A target that allows for conditional dependency on the compilation and

    -->
   <target name="maybejars"
      unless="nojars">
      <antcall target="jars" inheritRefs="true"/>
   </target>

   <!-- 
      This is an ugly hack, but our only option. In EWP, there's nothing like
      the "all" profile. So, we take "production", which contains "everything" for
      the distribution, but we use some configuration files from "default", as 
      "production" is secured and optimized, so some options are disabled
   -->
   <target name="create-profiles-for-ewp" if="build.ewp">
      <copy todir="${jboss.dist}/server/testing">
         <fileset dir="${jboss.dist}/server/production"/>
      </copy>
      
      <copy file="${jboss.dist}/server/default/deploy/jca-jboss-beans.xml" 
         tofile="${jboss.dist}/server/testing/deploy/jca-jboss-beans.xml" overwrite="true"/>
         
      <copy file="${jboss.dist}/server/default/conf/jboss-service.xml" 
         tofile="${jboss.dist}/server/testing/conf/jboss-service.xml" overwrite="true"/>
         
      <copy file="${jboss.dist}/server/default/deploy/hdscanner-jboss-beans.xml" 
         tofile="${jboss.dist}/server/testing/deploy/hdscanner-jboss-beans.xml" overwrite="true"/>
      
      <copy todir="${jboss.dist}/server/all">
         <fileset dir="${jboss.dist}/server/testing"/>
      </copy>
      
      <copy todir="${jboss.dist}/server/minimal">
         <fileset dir="${jboss.dist}/server/testing"/>
      </copy>
      
      <copy todir="${jboss.dist}/server/standard">
         <fileset dir="${jboss.dist}/server/testing"/>
      </copy>
      
      <copy todir="${jboss.dist}/server/web">
         <fileset dir="${jboss.dist}/server/testing"/>
      </copy>
      
      <delete dir="${jboss.dist}/server/default"/>
      <copy todir="${jboss.dist}/server/default">
         <fileset dir="${jboss.dist}/server/testing"/>
      </copy>
   </target>

   <!-- The top level entry point for all tests that can be run against
   variations of the standard jboss dist. This does not include long
   running benchmark oriented tests.
   -->
   <target name="tests" description="Execute all non-benchmark tests."
      depends="maybejars,create-profiles-for-ewp">
      <record name="${basedir}/output/tests.log" append="no" action="start" loglevel="info"/>
      <property name="nojars" value="true"/>
      <antcall target="jboss-minimal-tests" />
      <antcall target="jboss-all-config-tests"/>
      <antcall target="tests-profileservice"/>
      <antcall target="tests-bootstrap-dependencies"/>
      <antcall target="tests-springdeployer"/>
      <antcall target="tests-security-manager"/>
      <antcall target="tests-clustering-all-stacks"/>
      <antcall target="tomcat-ssl-tests"/>
      <antcall target="tomcat-sso-tests"/>
      <antcall target="tomcat-webctx-tests"/>
      <antcall target="tomcat-federation-tests"/>
      <antcall target="tests-binding-manager"/>
      <antcall target="tests-jacc-security"/>
      <antcall target="tests-jacc-securitymgr"/>
      <antcall target="tests-jacc-security-allstarrole"/>
<!--
      <antcall target="tests-security-jaspi-unit"/>
-->
      <antcall target="tests-jbossmessaging"/>
<!-- Temporarily disabling, doesn't work with hornetq, need to conditionally run this target only for jboss messaging
      <antcall target="tests-jbossmessaging-cluster"/>
-->
      <antcall target="tests-compatibility"/>
      <antcall target="tests-aop-scoped"/>
      <antcall target="jrmp-invoker-tests"/>
      <antcall target="pooled-invoker-tests"/>
      <antcall target="tests-jts" />
   
      <!-- Run classloader leak tests in isolation 	
      <antcall target="tests-classloader-leak"/>
      <antcall target="tests-clustered-classloader-leak"/>
       -->

      <antcall target="tests-jbpapp6517"/>
      <antcall target="tests-jbpapp6469"/>
      <antcall target="tests-jbpapp6523"/>
      <antcall target="tests-jbpapp9326"/>
   	  <antcall target="tests-jbpapp7794"/>
	
      <antcall target="tests-report"/>
      <!-- JBAS-5918 https://issues.apache.org/bugzilla/show_bug.cgi?id=41368 
      <record name="${basedir}/output/tests.log" action="stop"/>
      -->
      <condition property="servers.shutdown.failed">
         <and>
            <not><isset property="servers.shutdown.nocheck"/></not>
            <isfileselected file="output/tests.log">
               <or>
                  <contains text="Unable to shutdown server properly"/>
                  <not><contains text="[server:stop]"/></not>
               </or>
            </isfileselected>
         </and>
      </condition>
      <fail message="Some servers failed to shutdown cleanly."
         if="servers.shutdown.failed"/>
   </target>

   <target name="tests-stress" description="Execute all stress tests."
      depends="tests-standard-stress,
               tests-report">
   </target>

   <target name="jboss-minimal-tests"
      description="Validate the minimal config" unless="build.ewp">
      <server:start name="minimal"/>
      <copy file="${build.lib}/shutdown.sar"
         todir="${jboss.dist}/server/minimal/deploy" />
      <echo message="Minimal server started, stopping"/>
      <sleep seconds="10"/>
      <delete file="${jboss.dist}/server/minimal/deploy/shutdown.sar" />
      <sleep seconds="7"/>
   </target>

   <target name="jboss-all-config-tests"
      description="The units tests which are run against the jboss all config" depends="init">
   	

   	<!-- Default configuration to run the tests against -->
   	<property name="conf" value="all"/>
   	       
   	  <echo message="Replacing hornetq-roles and hornetq-users.properties used for tests"/>
   	
 	  <copy file="${module.output}/resources/test-configs/jbossmessaging/conf/props/hornetq-roles.properties" 
 	  	  tofile="${jboss.dist}/server/${conf}/conf/props/hornetq-roles.properties" overwrite="true"/>
    
 	  <copy file="${module.output}/resources/test-configs/jbossmessaging/conf/props/hornetq-users.properties" 
 	  	  tofile="${jboss.dist}/server/${conf}/conf/props/hornetq-users.properties" overwrite="true"/>
    
   	  <server:start name="${conf}"/>
      <antcall target="tests-standard-unit">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>

      <antcall target="tests-client-unit">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>

      <antcall target="tests-security-basic-unit">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>

      <antcall target="tests-standard-stress"/>
      <antcall target="tests-jbossmx-compliance"/>
      <antcall target="tests-jbossmx-implementation"/>
      <antcall target="tests-jbossmx-performance"/>
      <antcall target="tests-iiop"/>
      <antcall target="tests-scout-jaxr"/>
      <antcall target="tests-webservice" />
      <antcall target="tests-ws" />
      <antcall target="tests-aspects"/>
      <server:stop name="${conf}"/>
   </target>
   
   <target name="security-basic-tests"
      description="The units tests which are run against the jboss all config" depends="init">


      <!-- Default configuration to run the tests against -->
      <property name="conf" value="all"/>

      <echo message="Replacing hornetq-roles and hornetq-users.properties used for tests"/>

      <copy file="${module.output}/resources/test-configs/jbossmessaging/conf/props/hornetq-roles.properties" 
 	  	  tofile="${jboss.dist}/server/${conf}/conf/props/hornetq-roles.properties" overwrite="true"/>

      <copy file="${module.output}/resources/test-configs/jbossmessaging/conf/props/hornetq-users.properties" 
 	  	  tofile="${jboss.dist}/server/${conf}/conf/props/hornetq-users.properties" overwrite="true"/>

      <server:start name="${conf}"/>

      <antcall target="tests-security-basic-unit">
         <param name="custom.excludes" value="ec2.excludes" />
      </antcall>

      <server:stop name="${conf}" />
   </target>

   <!-- Calculates MD5 sums for all libraries used while testing.
        This will be used as proof of testing for CC evaluation.
   -->
   <target name="calculate-md5">
     <mkdir dir="${build.reports}/html"/>

     <java classname="org.jboss.test.util.CheckSumCalculator">
       <classpath>
         <pathelement location="${build.classes}" /> 
       </classpath>
       <arg line="-base ${jboss.dist}/ -output ${build.reports}/html/allmd5sum.txt -d ${jboss.dist}/lib -d ${jboss.dist}/server/cc/lib -d ${jboss.dist}/server/cc/deploy -d ${jboss.dist}/client"/>
     </java>

   </target>
     
   <!-- This target creates CC configuration -->
   <target name="create-cc-config" description="Creates CC configuration">
	  
      <delete dir="${jboss.dist}${/}server${/}cc" quiet="true"/>      
	  <delete dir="${jboss.dist}${/}server${/}cc-audit" quiet="true"/>      

	  <!-- Create the CC config starting with the production config -->
      <create-config baseconf="production" newconf="cc">
         <patternset>
            <include name="conf/**" />
            <include name="deployers/**" />
            <include name="deploy/**" />
            <include name="deploy-hasingleton/**" />
            <include name="farm/**" />
            <include name="lib/**" />
         </patternset>
      </create-config>

      <!-- Additional cc config modifications -->
      <copy file="${build.resources}/cc/cc.policy" todir="${jboss.dist}/server/cc" />
      
      <!-- runs only when "cc.use.natives" property is set to true -->
      <antcall target="modify-cc-to-natives"/>
      
      
      <!-- delete SNMP adapter, because it is not allowed in CC config -->
      <delete dir="${jboss.dist}/server/cc/deploy/snmp-adaptor.sar"/>

      <!-- delete HSQL DB which is not allowed in CC config 
           Alternate configuration at test-configs/cc/deploy contains DefaultDS 
           file called oracle-ds.xml for default Oracle DB. 
      -->
      <!-- delete file="${jboss.dist}/common/lib/hsqldb.jar"/ -->
      <!-- delete file="${jboss.dist}/common/lib/hsqldb-plugin.jar"/ -->
      <delete file="${jboss.dist}/server/cc/deploy/hsqldb-ds.xml"/>
      <delete file="${jboss.dist}/server/cc/deploy/messaging/hsqldb-persistence-service.xml"/>

      <!-- Disable Remote Method Invocation (RMI) under the Internet Inter-ORB Protocol (IIOP) -->
      <delete file="${jboss.dist}/server/cc/conf/jacorb.properties"/>
      <delete file="${jboss.dist}/server/cc/deploy/iiop-service.xml"/>
      <delete file="${jboss.dist}/server/cc/lib/jacorb.jar"/>
      <!-- delete file="${jboss.dist}/common/lib/jboss-iiop.jar"/ -->

      <!-- copy alternate part of configuration with regards to DB -->
      <copy todir="${jboss.dist}/server/cc/deploy" overwrite="true">
        <fileset dir="${cc.db.config.home}/${cc.db.config}">
          <include name="*"/>
        </fileset>
      </copy>

      <!-- copy alternate part of configuration using property cc.login.config -->
      <copy todir="${jboss.dist}/server/cc" overwrite="true">
        <fileset dir="${build.resources}/cc/${cc.login.config}">
          <include name="**/*"/>
        </fileset>
      </copy>
      
      <!-- DB config patch (copy JDBC driver library) -->
      <get src="http://reports.qa.atl.jboss.com/jdbc-drivers-products/EAP/5.1.0/${cc.path.jdbc.driver}/${cc.jdbc.driver}" 
           dest="${jboss.dist}/server/cc/lib/${cc.jdbc.driver}" />

      <!-- create cc-audit as copy of cc -->
      <create-config baseconf="cc" newconf="cc-audit">
         <patternset>
            <include name="conf/**" />
            <include name="deployers/**" />
            <include name="deploy/**" />
            <include name="deploy-hasingleton/**" />
            <include name="farm/**" />
            <include name="lib/**" />
            <include name="cc.*"/>
            <include name="ssl.*"/>
            <include name="localhost.*"/>
         </patternset>
      </create-config>

      <!-- create cc-secured as copy of cc -->
      <create-config baseconf="cc" newconf="cc-secured">
         <patternset>
            <include name="conf/**" />
            <include name="deployers/**" />
            <include name="deploy/**" />
            <include name="deploy-hasingleton/**" />
            <include name="farm/**" />
            <include name="lib/**" />
            <include name="cc.*"/>
            <include name="ssl.*"/>
            <include name="localhost.*"/>
         </patternset>
      </create-config>

      <!-- create cc-cxf as copy of cc -->
      <create-config baseconf="cc" newconf="cc-cxf">
         <patternset>
            <include name="conf/**" />
            <include name="deployers/**" />
            <include name="deploy/**" />
            <include name="deploy-hasingleton/**" />
            <include name="farm/**" />
            <include name="lib/**" />
            <include name="cc.*"/>
            <include name="ssl.*"/>
            <include name="localhost.*"/>
         </patternset>
      </create-config>
      
      <!-- prepare run.conf for audit testing -->
      <echo file="${jboss.dist}/server/cc-audit/run.conf">
      JAVA_OPTS="-Xms128m -Xmx512m -XX:MaxPermSize=256m -Dorg.jboss.resolver.warning=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000 -Dsun.lang.ClassLoader.allowArraySyntax=true -Djboss.home.dir=${jboss.dist} -Djboss.server.home.dir=${jboss.dist}/server/cc-audit -Djava.security.manager -Djava.security.policy==${jboss.dist}/server/cc-audit/cc.policy -Dcc.jdbc.driver=${cc.jdbc.driver}"</echo>

      <!-- prepare run.conf for later CXF testing -->
      <echo file="${jboss.dist}/server/cc-cxf/run.conf">
      JAVA_OPTS="-Xms128m -Xmx512m -XX:MaxPermSize=512m -Dorg.jboss.resolver.warning=true -Dsun.rmi.dgc.client.gcInterval=3600000 -Dsun.rmi.dgc.server.gcInterval=3600000 -Dsun.lang.ClassLoader.allowArraySyntax=true -Djboss.home.dir=${jboss.dist} -Djboss.server.home.dir=${jboss.dist}/server/cc-cxf -Djava.security.manager -Djava.security.policy==${jboss.dist}/server/cc-cxf/cc.policy -Dcc.jdbc.driver=${cc.jdbc.driver}"</echo>

      <!-- JTA tests CC related config -->
      <copy todir="${build.resources}/jbossts/scripts/imports/" overwrite="true">
        <fileset dir="${build.resources}/cc/jta">
          <include name="**/*"/>
        </fileset>
      </copy>
      
   </target>

   <!-- Modify default cc config to use jboss natives -->   
   <target name="modify-cc-to-natives" if="cc.use.natives">
      <copy todir="${jboss.dist}/server/cc" overwrite="true">
        <fileset dir="${build.resources}/test-configs/cc-native">
          <include name="**/*"/>
        </fileset>
      </copy>
   </target>
      
   
   <!-- 
     | Tests for Common Criteria Evaluation. The JBoss server must be running with a security manager for those tests 
     | This target has to run with jboss.test.sign.jars property set to true.    
   -->
   <target name="tests-common-criteria" description="Tests run against a jboss server configured according to CC Guide" depends="init">

      <property name="cc-testify" value="true"/>

      <antcall target="create-cc-config" />
      
      <echo message="Starting CC with policy ${build.resources}/test-configs/cc/cc.policy" />
      <echo message="jboss.home.dir=${jboss.dist}" />
      <echo message="jboss.server.home.dir=${jboss.dist}${/}server${/}cc" />
      <echo message="java.naming.provider.url=jnp://localhost:1099" />
      <echo message="jbosstest.server.host=localhost" />
      <echo message="cc.java.security.debug=${cc.java.security.debug}" />

      <server:start name="cc" />


      <junit dir="${module.output}" printsummary="true" haltonerror="false" haltonfailure="false" fork="true" timeout="${junit.timeout}" jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}" />

         <!-- sysproperty key="java.naming.provider.url" value="${node0.jndi.url}" />
         <sysproperty key="jbosstest.server.host" value="${node0}" / -->
         <sysproperty key="java.naming.provider.url" value="jnp://localhost:1099" />
         <sysproperty key="jbosstest.server.host" value="localhost" />
         <sysproperty key="jboss.home" file="${project.root}" />
         <sysproperty key="jboss.thirdparty.dir" file="${project.root}/thirdparty" />
         <sysproperty key="jboss.tools.dir" file="${project.root}/tools" />
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}" />
         <sysproperty key="jbosstest.secure" value="true" />
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf" />
         <sysproperty key="build.testlog" value="${build.testlog}" />
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml" />

         <!-- all entries from ${build.resources}/test-configs/tomcat-ssl/conf/client.keystore 
              were imported to ssl.truststore -->    
         <sysproperty key="javax.net.ssl.trustStore" value="${build.resources}/test-configs/cc/ssl.truststore" />
         <sysproperty key="javax.net.ssl.trustStorePassword" value="123456" />
         <sysproperty key="javax.net.ssl.keyStore" value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore" />
         <sysproperty key="javax.net.ssl.keyStorePassword" value="unit-tests-client" />
         
         <!-- Disable test -->
         <sysproperty key="cc.disabled.test.methods" value="testSecurityDomain" />

         <!-- tomcat-ssl tests -->
         <sysproperty key="web.port" value="8081" />
         <sysproperty key="secureweb.port" value="8443" />
         <!-- RMI over http/s tests -->
         <sysproperty key="rmi.over.web.port" value="8080" />
         <sysproperty key="rmi.over.secureweb.port" value="8445" />
         
         <sysproperty key="java.protocol.handler.pkgs" value="javax.net.ssl" />
         
         <classpath>
            <pathelement location="${build.resources}" />
            <pathelement location="${build.resources}/security" />
            <pathelement location="${build.classes}" />
            <path refid="tests.classpath" />
         </classpath>

         <sysproperty key="jboss-junit-configuration" value="tests-security-manager" />
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-tests-security-manager.xml" />

         <batchtest todir="${build.reports}" haltonerror="false" haltonfailure="false" fork="true">
            <fileset dir="${build.classes}">
               <!-- <include name="org/jboss/test/aop/test/SecurityUnitTestCase.class"/> -->
               <!-- <exclude name="org/jboss/test/securitymgr/test/PolicyUnitTestCase.class" /> -->
               <!-- include name="org/jboss/test/security/test/EJB3SpecUnitTestCase.class"/ -->
               <!-- include name="org/jboss/test/security/test/EJBSpecUnitTestCase.class"/ -->
               
               
               <include name="org/jboss/test/jbossmessaging/test/Jms11UnitTest.class"/>
               <include name="org/jboss/test/jbossmessaging/test/SecurityUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/EJB3SpecUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/EJBSpecUnitTestCase.class"/>
               <include name="**/test/tm/test/TxTimeout*TestCase.class"/>
               <include name="org.jboss.test.deployers.web.test.WEBDeploymentUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/SubjectContextUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/DeepCopySubjectUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/LoginContextUnitTestCas.class"/>
               <include name="org/jboss/test/security/test/NamespacePermissionsUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/PermissionNameUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/WebConstraintsUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/WebResourcePermissionUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/WebUserDataPermissionUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/auth.AppCallbackHandlerUnitTestCase.class"/>
               <include name="org/jboss/test/jmx/test/RMIAdaptorAuthorizationUnitTestCase.class"/>
               <include name="org/jboss/test/jmx/testRMIAdaptorUnitTestCase.class"/>
               <include name="org/jboss/test/jmx/test/RMIAdaptorUnitTestCase.class"/>
               <include name="org/jboss/test/jbossmx/compliance/registration/MXBeanRegistrationTestCase.java"/>
               <include name="org/jboss/test/security/test/ClientLoginModuleEJBUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/ClientLoginModuleUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/CustomPrincipalPropagationUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/DynamicLoginConfigServiceUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/EJBPermissionUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/JaasSecurityDomainUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/LoginModulesUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/MissingMethodUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/RoleMappingModuleUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/SAInheritableThreadLocalUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/SAThreadLocalUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/SecurityDomainLoginModuleOptionUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/SecurityMgrStressTestCase.class"/>
               <include name="org/jboss/test/security/test/SecurityProxyUnitTestCase.class"/>
               <include name="org/jboss/test/security/test/XMLLoginModulesUnitTestCase.class"/>
               <include name="org/jboss/test/web/security/CustomHeaderAuthTestCase.class"/>
               <include name="org/jboss/test/jmx/test/SecureRMIAdaptorUnitTestCase.class"/>
               <include name="org/jboss/test/tm/test/TxTimeoutAnnotUnitTestCase.class"/>
               <include name="org/jboss/test/invokers/test/MultiInvokersUnitTestCase.class"/>

               <include name="org/jboss/test/web/test/FormAuthUnitTestCase.class"/>
               <include name="org/jboss/test/web/test/SingleSignOnUnitTestCase.class"/>
               <include name="org/jboss/test/web/test/UserInRoleUnitTestCase.class"/>
               <include name="org/jboss/test/web/test/WebProgrammaticLoginTestCase.class"/>
               <include name="org/jboss/test/web/test/WebIntegrationUnitTestCase.class"/>

               <include name="org/jboss/test/security/rmi/test/RMIOverHttpsTestCase.class"/>
               <include name="org/jboss/test/web/test/ssl/SSLUnitTestCase.class"/>

               <include name="org/jboss/test/naming/test/SecurityUnitTestCase.class"/>

               <include name="org/jboss/test/ejb3/jbpapp2473/unit/RunAsUnitTestCase.class"/>

               <include name="org/jboss/test/aop/test/SecurityUnitTestCase.class"/>

            </fileset>
         </batchtest>
      </junit>

      <antcall target="cc-tests-ws"/>
      
      <echo>Waiting for server to shutdown...</echo>
      <server:stop name="cc"/>

      <antcall target="cc-tests-secured"/>
      <antcall target="cc-tests-cluster"/>
      
      <antcall target="tests-cc-audit"/>
      
      <!-- Because CXF tests could be run later, we have to split and call those targets in separate ant run at the end. 
      <antcall target="calculate-md5"/>
      <antcall target="tests-report"/>
      -->
   </target>

  <target name="cc-tests-secured" description="Tests run against secured configuration">


     <server:start name="cc-secured" />


     <junit dir="${module.output}" printsummary="true" haltonerror="false" haltonfailure="false" fork="true" timeout="${junit.timeout}" jvm="${junit.jvm}">

        <jvmarg line="${junit.jvm.options}" />

        <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}" />
        <sysproperty key="jbosstest.server.host" value="${node0}" />
        <sysproperty key="jboss.home" file="${project.root}" />
        <sysproperty key="jboss.thirdparty.dir" file="${project.root}/thirdparty" />
        <sysproperty key="jboss.tools.dir" file="${project.root}/tools" />
        <sysproperty key="jbosstest.deploy.dir" file="${build.lib}" />
        <sysproperty key="jbosstest.secure" value="true" />
        <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf" />
        <sysproperty key="build.testlog" value="${build.testlog}" />
        <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml" />

        <!-- all entries from ${build.resources}/test-configs/tomcat-ssl/conf/client.keystore 
             were imported to ssl.truststore -->    
        <sysproperty key="javax.net.ssl.trustStore" value="${build.resources}/test-configs/cc/ssl.truststore" />
        <sysproperty key="javax.net.ssl.trustStorePassword" value="123456" />
        <sysproperty key="javax.net.ssl.keyStore" value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore" />
        <sysproperty key="javax.net.ssl.keyStorePassword" value="unit-tests-client" />
        
        <!-- tomcat-ssl tests -->
        <sysproperty key="web.port" value="8081" />
        <sysproperty key="secureweb.port" value="8443" />
        <!-- RMI over http/s tests -->
        <sysproperty key="rmi.over.web.port" value="8080" />
        <sysproperty key="rmi.over.secureweb.port" value="8445" />
        
        <sysproperty key="java.protocol.handler.pkgs" value="javax.net.ssl" />
        
        <classpath>
           <pathelement location="${build.resources}" />
           <pathelement location="${build.resources}/security" />
           <pathelement location="${build.classes}" />
           <path refid="tests.classpath" />
        </classpath>

        <sysproperty key="jboss-junit-configuration" value="tests-security-manager" />
        <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-tests-security-manager.xml" />

        <batchtest todir="${build.reports}" haltonerror="false" haltonfailure="false" fork="true">
           <fileset dir="${build.classes}">
              <include name="org/jboss/test/security/test/authorization/secured/*TestCase.class"/>
              <exclude name="org/jboss/test/security/test/authorization/secured/HttpRequestWebConsoleAuthenticationUnitTestCase.class"/>
           </fileset>
        </batchtest>
     </junit>

     <echo>Waiting for server to shutdown...</echo>
     <server:stop name="cc-secured"/>

  </target>
   
   
  <target name="cc-tests-cluster" description="Clustering tests for CC">

    <delete dir="${jboss.dist}${/}server${/}cc-cluster-*" quiet="true"/>      

    <patternset id="cc-cluster-tests.includes">
       <include name="org/jboss/test/cluster/defaultcfg/test/HAInvokerUnitTestCase.class"/>
       <include name="org/jboss/test/ann/clustered/test/Ejb3ClusteredAnnTestCase.class"/>
    </patternset>

    <property name="jboss.default.jgroups.stack" value="tcp"/>

    <antcall target="tests-clustering-configure" inheritRefs="true">
      <param name="conf" value="cc-cluster"/>
      <param name="baseconf" value="cc"/>
      <param name="newconf-src" value="cc-none"/>
    </antcall>   

    <server:start name="cc-cluster-0"/>
    <server:start name="cc-cluster-1"/>

    <antcall target="tests-clustering-unit">
     <param name="cluster.includes.refid" value="cc-cluster-tests.includes"/>
     <param name="jboss-junit-configuration" value="Default-${jboss.default.jgroups.stack}"/>
     <param name="jbosstest.cluster.web.cache.config" value="standard-session-cache"/>
     <param name="jbosstest.cluster.node0.config" value="cc-cluster-0"/>
     <param name="jbosstest.cluster.node1.config" value="cc-cluster-1"/>
    </antcall>

    <server:stop name="cc-cluster-0"/>
    <server:stop name="cc-cluster-1"/>
   </target>
   
   
   
   <target name="cc-tests-ws" description="WS tests for CC" unless="cc.run.cxf.tests">

      <!-- WS tests have their own Security Manager, so we have to use new instance of JUNIT -->
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf"/>
         <!-- sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/ -->
         <sysproperty key="java.naming.provider.url" value="jnp://localhost:1099" />
         <sysproperty key="jbosstest.server.host" value="localhost" />
         
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <!-- The crimson parser cannot do schema validation, which we need for jaxrpc-mapping.xml -->
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/security"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-webservice"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-ws.xml"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/ws/jaxws/ejb3Integration/injection/InjectionTestCase.class"/>
               <include name="org/jboss/test/webservice/endpoint/EndpointTestCase.class"/>
               <include name="org/jboss/test/webservice/admindevel/ExampleTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   
   </target> 
   
   <!-- Common Criteria Audit test -->
   <target name="tests-cc-audit">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    
    <!-- script tests which start their own servers -->
    <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="${junit.fork}"
	   timeout="${junit.timeout}" jvm="${junit.jvm}">
      
      <jvmarg value="${junit.jvm.options}"/>
      <!-- Used for JGroups -->
      <jvmarg value="-Dbind.address=${node0}"/>
      <sysproperty key="jboss.dist" value="${jboss.dist}"/>
      <sysproperty key="jbosstest.server.config" value="cc-audit"/>
      <sysproperty key="jboss.server.home.dir" value="${jboss.dist}${/}server${/}cc-audit"/>
      <sysproperty key="jbosstest.deploy.dir" value="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.server.host.url" value="${node0.url}"/>
      <sysproperty key="java.net.preferIPv4Stack" value="${java.net.preferIPv4Stack}" />
      <sysproperty key="java.net.preferIPv6Addresses" value="${java.net.preferIPv6Addresses}" />
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
		<propertyref prefix="jbosstest."/>
      </syspropertyset>
      <classpath>
		<pathelement location="${build.classes}"/>
		<pathelement location="${build.resources}"/>
		<path refid="tests.classpath"/>
      </classpath>
      
      <!--sysproperty key="jboss-junit-configuration" value="classloader-leak"/-->
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-security-audit.xml"/>
      
      <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">
	
	  <fileset dir="${build.classes}">
         <include name="**/test/security/audit/test/SecurityAuditTestCase.class"/>
         <!-- include name="**/test/scripts/test/RunTestCase.class"/>
         <include name="**/test/scripts/test/ShutdownTestCase.class"/ -->
	  </fileset>
      </batchtest>
    </junit>
   </target>

   <target name="tests-cluster-ec2" description="Runs the various test targets, but against cluster-ec2 config" depends="init">
      <record name="${basedir}/output/tests.log" append="no" action="start" loglevel="info"/>
      <property name="conf" value="cluster-ec2"/>
      <property name="baseconf" value="cluster-ec2"/>

      <antcall target="tests-jbossmessaging"/>

      <antcall target="tests-binding-manager"/>

<!-- Temporarily disabling, doesn't work with hornetq, need to conditionally run this target only for jboss messaging
      <antcall target="tests-jbossmessaging-cluster"/>
-->

      <antcall target="jboss-all-config-tests" inheritrefs="true">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>
      <antcall target="tests-clustering-cluster-ec2" inheritrefs="true">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>


      <antcall target="tests-report"/>
      <!-- JBAS-5918 https://issues.apache.org/bugzilla/show_bug.cgi?id=41368 
         <record name="${basedir}/output/tests.log" action="stop"/>
      -->
      <condition property="servers.shutdown.failed">
         <and>
            <not><isset property="servers.shutdown.nocheck"/></not>
            <isfileselected file="output/tests.log">
               <or>
                  <contains text="Unable to shutdown server properly"/>
                  <not><contains text="[server:stop]"/></not>
               </or>
            </isfileselected>
         </and>
      </condition>
      <fail message="Some servers failed to shutdown cleanly."
            if="servers.shutdown.failed"/>
   </target>
   
   <target name="tests-mod_cluster-ec2" description="Runs the various test targets, but against mod_cluster-ec2 config" depends="init">
      <record name="${basedir}/output/tests.log" append="no" action="start" loglevel="info"/>
      <property name="conf" value="mod_cluster-ec2"/>
      <property name="baseconf" value="mod_cluster-ec2"/>

      <antcall target="tests-jbossmessaging"/>

      <antcall target="tests-binding-manager"/>

<!-- Temporarily disabling, doesn't work with hornetq, need to conditionally run this target only for jboss messaging
      <antcall target="tests-jbossmessaging-cluster"/>
-->

      <antcall target="jboss-all-config-tests" inheritrefs="true">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>
      <antcall target="tests-clustering-mod_cluster-ec2" inheritrefs="true">
         <param name="custom.excludes" value="ec2.excludes"/>
      </antcall>


      <antcall target="tests-report"/>
      <!-- JBAS-5918 https://issues.apache.org/bugzilla/show_bug.cgi?id=41368 
         <record name="${basedir}/output/tests.log" action="stop"/>
      -->
      <condition property="servers.shutdown.failed">
         <and>
            <not><isset property="servers.shutdown.nocheck"/></not>
            <isfileselected file="output/tests.log">
               <or>
                  <contains text="Unable to shutdown server properly"/>
                  <not><contains text="[server:stop]"/></not>
               </or>
            </isfileselected>
         </and>
      </condition>
      <fail message="Some servers failed to shutdown cleanly."
            if="servers.shutdown.failed"/>
   </target>

   <target name="smoke-tests"
      description="A basic set of units tests which are run against the jboss all config" depends="init">
      <server:start name="all"/>
      <antcall target="smoke-tests-raw"/>
      <server:stop name="all"/>
   </target>

   <target name="tests-profileservice" description="Tests with the full featured profile service">
      <create-profileservice-config baseconf="default" conf="profileservice"/>
      <server:start name="profileservice"/>
      <run-junit
         junit.patternset="profileservice.includes"
         junit.configuration="profileservice"
      />
      <server:stop name="profileservice"/>
	  <!-- test profileservice persistence, after restarting AS -->       	
      <server:start name="profileservice"/>
      <run-junit
         junit.patternset="profileservice.restart.includes"
         junit.configuration="profileservice"
      />
      <server:stop name="profileservice"/>
   </target>
   <target name="profileservice-config" description="Create the full featured profile service config">
      <create-profileservice-config baseconf="default" conf="profileservice"/>
   </target>
	
   <target name="tests-web-profile" description="Tests with the web profile">
      <server:start name="web"/>
      <antcall target="run-web-profile-unit"/>
      <server:stop name="web"/>
   </target>
   
   <target name="tests-springdeployer" description="Tests with the full featured spring deployer">
      <create-springdeployer-config baseconf="default" conf="springdeployer"/>
      <server:start name="springdeployer"/>
      <run-junit junit.patternset="springdeployer.includes" junit.configuration="springdeployer"/>
      <server:stop name="springdeployer"/>
   </target>
   <target name="springdeployer-config" description="Create the full featured spring deployer config">
      <create-springdeployer-config baseconf="default" conf="springdeployer"/>
   </target>

   <!-- Tests of tomcat needing a ssl connector
   -->
   <target name="tomcat-ssl-tests"
      description="Tomcat tests requiring an SSL connector">
      <!-- Create the ssl enabled tomcat config -->
      <create-config baseconf="default" newconf="tomcat-ssl">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/security/**"/>
            <include name="deploy/jca*"/>
            <include name="deploy/legacy*"/>
            <include name="lib/**"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/transaction-jboss-beans.xml"/>
         </patternset>
      </create-config>

      <server:start name="tomcat-ssl"/>

      <!-- Specify the JSSE properties -->
      <property name="javax.net.ssl.keyStore"
         value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore"/>
      <property name="javax.net.ssl.keyStorePassword" value="unit-tests-client"/>
      <property name="javax.net.ssl.trustStore"
         value="${build.resources}/test-configs/tomcat-ssl/conf/client.keystore"/>
      <property name="javax.net.ssl.trustStorePassword" value="unit-tests-client"/>

      <propertyset id="tomcat-ssl-tests-props">
         <propertyref prefix="javax.net.ssl"/>
      </propertyset>
      <run-junit junit.patternset="tc-ssl.includes"
        junit.configuration="tomcat-ssl-tests"
	junit.syspropertyset="tomcat-ssl-tests-props" />

      <server:stop name="tomcat-ssl"/>
   </target>

   <!-- Tests of tomcat requiring SSO configured
   -->
   <target name="tomcat-sso-tests"
      description="Tomcat tests requiring SSO configured">
      <!-- Create the sso enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="tomcat-sso">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="tomcat-sso"/>
      <run-junit junit.patternset="tc-sso.includes"
	junit.configuration="tomcat-sso" />
      <server:stop name="tomcat-sso"/>
   </target>

	 <!-- Tests that require the attribute "UseJBossWebLoader" set to true -->
   <target name="tomcat-webctx-tests"
       description="Tomcat tests requiring classloader set to the web loader">
       <create-config baseconf="default" newconf="tomcat-webctx"
         newconf-src="tomcat-webctx">
        <patternset>
           <include name="conf/**"/>
           <include name="deployers/**"/>
           <include name="deploy/**"/>
           <include name="lib/**"/>           
         </patternset>
      </create-config>

       <server:start name="tomcat-webctx"/>
       <run-junit junit.patternset="tomcat.webctx.includes"
	junit.configuration="tomcat-webctx"  />
       <server:stop name="tomcat-webctx"/>
    </target>

   <!-- Tests of tomcat requiring Federation configured
   -->
   <target name="tomcat-federation-tests"
      description="Tomcat tests requiring Federation configured">
      <!-- Create the federation enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="tomcat-federation">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/jboss-jdbc-metadata.sar"/>
            <include name="deploy/security*"/>
            -->
         </patternset>
      </create-config>
      <copy file="${source.resources}/web/federation/authext/war-deployers-jboss-beans.xml" overwrite="true" todir="${jboss.dist}/server/tomcat-federation/deployers/jbossweb.deployer/META-INF" />
      <copy file="${build.lib}/header-auth.jar" overwrite="true" todir="${jboss.dist}/server/tomcat-federation/deploy/jbossweb.sar" />
      <server:start name="tomcat-federation"/>
      <run-junit junit.patternset="tc-federation.includes"
	junit.configuration="tomcat-federation" />
      <server:stop name="tomcat-federation"/>
   </target>

   <target name="tests-binding-manager"
     description="Test for clean startup with service binding manager">

     <property name="baseconf" value="all"/>
 	
     <create-cluster-node conf="binding-manager1" baseconf="${baseconf}"/>
     <create-cluster-node conf="binding-manager2"  baseconf="${baseconf}"/>
     <server:start name="binding-manager1"/>
     <server:start name="binding-manager2"/>

     <run-junit junit.patternset="binding-manager.includes"
	            junit.configuration="binding-manager" />

     <server:stop name="binding-manager1"/>
     <server:stop name="binding-manager2"/>
   </target>

   <!--
     | Tests ejb calls using the jrmp invoker
   -->
   <target name="jrmp-invoker-tests"
      description="EJB tests using the jrmp invoker">
      <!-- Create the jrmp invoker enabled config -->
      <create-config baseconf="default" newconf="jrmp-invoker">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="jrmp-invoker"/>

      <run-junit junit.patternset="jrmp-invoker.includes"
         junit.configuration="JRMP-Invoker" />

      <server:stop name="jrmp-invoker"/>
   </target>

   <!--
     | Tests ejb calls using the pooled invoker
   -->
   <target name="pooled-invoker-tests"
      description="EJB tests using the jrmp invoker">
      <!-- Create the jrmp invoker enabled config -->
      <create-config baseconf="default" newconf="pooled-invoker">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="pooled-invoker"/>

      <!-- This is pooled but we use the same tests as jrmp -->
      <run-junit junit.patternset="jrmp-invoker.includes"
         junit.configuration="Pooled-Invoker" />

      <server:stop name="pooled-invoker"/>
   </target>

   <!--
     | Tests DeploymentService
   -->
   <target name="deployment-service-tests"
      description="Tests targeting the deployment service">
      <!-- Create clean configuration -->
      <delete dir="${jboss.dist}/server/deployment-service" />
      <create-config baseconf="default" newconf="deployment-service">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/messaging/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            -->
         </patternset>
      </create-config>
      <!-- overlay the deployment-service stuff -->
      <copy todir="${jboss.dist}/server/deployment-service/conf">
         <fileset dir="${jboss.dist}/docs/examples/varia/deployment-service">
            <include name="templates/**"/>
         </fileset>
      </copy>
      <copy todir="${jboss.dist}/server/deployment-service/deploy">
         <fileset dir="${jboss.dist}/docs/examples/varia/deployment-service">
            <include name="deployment-service.sar"/>
         </fileset>
      </copy>
      <server:start name="deployment-service"/>
      <antcall target="deployment-service-unit-tests">
         <param name="jboss-junit-configuration" value="DeploymentService"/>
      </antcall>
      <server:stop name="deployment-service"/>
   </target>

   <target name="deployment-service-unit-tests">
     <run-junit junit.patternset="deployment-service.includes"
        junit.configuration="deployment-service"/>
   </target>

  <!--
     A minimal set of tests
     
     This should have a wide variety of basic tests,
     that don't take very long to run.
  -->
  <target name="smoke-tests-raw" depends="init">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
      	 <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/aop/test/AOPUnitTestCase.class"/>
               <include name="org/jboss/test/classloader/test/ScopingUnitTestCase.class"/>
               <include name="org/jboss/test/cts/test/*UnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/StatefulSessionLocalUnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/StatefulSessionUnitTestCase.class"/>
               <exclude name="org/jboss/test/cts/test/LongWaitStatefulSessionUnitTestCase.class"/>
               <include name="org/jboss/test/ejb3/test/SimpleSessionUnitTestCase.class"/>
               <include name="org/jboss/test/jbossmessaging/test/JBossMessagingJoramUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/BaseConnectionManagerUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/PoolingUnitTestCase.class"/>
               <include name="org/jboss/test/jca/test/XADSUnitTestCase.class"/>
               <include name="org/jboss/test/jmsra/test/*UnitTestCase.class"/>
               <include name="org/jboss/test/naming/test/SimpleUnitTestCase.class"/>
               <include name="org/jboss/test/tm/test/TransactionManagerUnitTestCase.class"/>
               <include name="org/jboss/test/web/test/WebIntegrationUnitTestCase.class"/>
               <include name="org/jboss/test/xml/DDValidatorUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

  <!--
     Web Profile Tests
  -->
  <target name="run-web-profile-unit" depends="init">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.factory.initial" value="org.jboss.naming.HttpNamingContextFactory"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.http.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}" extension="-web-profile.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/jpa/test/WebClassesJPAUnitTestCase.class"/>
               <include name="org/jboss/test/jpa/test/WebLibsJPAUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Standard tests that should run successfully against a default JBoss
      | server distribution build.
    -->

  <target name="tests-standard-unit">
      <echo><![CDATA[
   junit.timeout:              ${junit.timeout}
   jbosstest.iterationcount:   ${jbosstest.iterationcount}
   jbosstest.threadcount:      ${jbosstest.threadcount}
   jbosstest.beancount:        ${jbosstest.beancount}
         ]]></echo>
  	
  	
  	   <property name="custom.excludes" value="empty.patternset"/>
  	
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
      	 <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.useJBM" value="true"/>

      	 <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/*UnitTestCase.class"/>
               
               <!-- Tests should follow the pattern above, but this one doesn't. JBPAPP-5133 -->
               <include name="**/test/ejb3/jbpapp4681/unit/TimerServiceRestoreTestCase.class"/>
               
               <patternset refid="all.excludes"/>
               <patternset refid="${custom.excludes}"/>
               <exclude name="**/test/xa/test/XAUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="tests-standard-stress">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
	 <sysproperty key="jboss-junit-configuration" value="tests-standard-stress"/>
	 <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
		  usefile="${junit.formatter.usefile}"
		  extension="-tests-standard-stress.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/*StressTestCase.class"/>
               <patternset refid="all.excludes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <!--
      | Tests that need to be run by loading the testcase code from a client
      | jar rather than the build.classes.dir. Typically these tests need to
      | control how classes are loaded.
    -->
   <target name="tests-client-unit">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <property name="custom.excludes" value="empty.patternset"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy"
            value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>

         <classpath>
            <pathelement path="${build.lib}/jrmp-dl-client.jar"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-client-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-client-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/jrmp/test/DynLoadingUnitTestCase.class"/>
               <include name="org/jboss/test/jrmp/test/DynLoadingFromSARUnitTestCase.class"/>
               <include name="org/jboss/test/jrmp/test/DynLoadingFromSARUnpackedUnitTestCase.class"/>
               <patternset refid="${custom.excludes}"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Standard security tests that should run successfully against a default
      | JBoss server distribution build.
    -->
   <target name="tests-security-basic-unit">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <property name="custom.excludes" value="empty.patternset"/>
      <property name="jbosstest.secure" value="true"/>
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="security-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>

      <run-junit junit.patternset="security.includes"
         junit.syspropertyset="security-tests-props"
         junit.configuration="tests-security-basic-unit" 
         junit.excludeset="${custom.excludes}"/>
   </target>

   <!-- Tests of Java2 permissions. The JBoss server must be running with
    a security manager for this test -->
   <target name="tests-security-manager"
      description="Tests run against a jboss server with a security manager">

      <create-config baseconf="default" newconf="secmgr">
        <patternset>
           <include name="conf/**"/>
           <include name="deployers/**"/>
           <include name="deploy/**"/>
           <include name="lib/**"/>
        </patternset>
      </create-config>


      <echo message="Starting secmgr with policy ${build.resources}/securitymgr/server.policy" />
      <echo message="jboss.home.dir=${jboss.dist}" />
      <echo message="jboss.server.home.dir=${jboss.dist}${/}server${/}secmgr" />
      <echo message="java.naming.provider.url=${node0.jndi.url}" />
      <echo message="jbosstest.server.host=${node0}" />

      <server:start name="securitymgr"/>

      <junit dir="${module.output}"
         printsummary="true"
         haltonerror="false"
         haltonfailure="false"
         fork="true"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jboss.home" file="${project.root}"/>
         <sysproperty key="jboss.thirdparty.dir" file="${project.root}/thirdparty"/>
         <sysproperty key="jboss.tools.dir" file="${project.root}/tools"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.resources}"/>
            <pathelement location="${build.classes}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <sysproperty key="jboss-junit-configuration" value="tests-security-manager"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-security-manager.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="false"
            haltonfailure="false"
            fork="true">

            <fileset dir="${build.classes}">
               <exclude name="org/jboss/test/securitymgr/test/PolicyUnitTestCase.class"/>
                <patternset refid="securitymgr.includes"/>
            </fileset>
         </batchtest>
      </junit>
   	
      <echo>Waiting for server to shutdown...</echo>
      <server:stop name="securitymgr"/> 

   </target>

	<target name="tests-logmod-ldap"
      description="Tests security tests running agains ldap login module.">

      <antcall target="create-logmod-ldap-config" />
      <server:start name="logmod-ldap"/>

      <antcall target="tests-security-basic-unit"/>
      
      <server:stop name="logmod-ldap"/>
   </target>

   <target name="create-logmod-ldap-config" description="Creates required logmod-ldap configuration">
       <!-- Create the security-tst config starting with the "all" config -->
       <create-config baseconf="all" newconf="logmod-ldap" newconf-src="logmod-ldap">
         <patternset>
           <include name="**/*"/>
         </patternset>
       </create-config>
   </target>   

   <!-- Tests of the JACC security implementation -->
   <target name="tests-jacc-security"
      description="Tests run against a jboss server with JACC configured">
      <!-- Create the ssl enabled tomcat config -->
      <create-config baseconf="default" newconf="jacc">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/ejb2-timer-service.xml"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/jbossws.sar/**"/>
            <include name="deploy/client-deployer-service.xml"/>
            <include name="deploy/jms-ds.xml"/>
            <include name="deploy/jms-ra.rar"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/mail-service.xml"/>
            <include name="deploy/messaging/**"/>
            <include name="deploy/ejb3-interceptors-aop.xml"/>
            <include name="deploy/security-beans.xml"/>
            -->
         </patternset>
      </create-config>
      <!-- Copy the test-destinations-service.xml to the all config.
          Additionally this file should be there in the jacc config
      <copy file="${build.resources}/messaging/test-destinations-full-service.xml"
      todir="${jboss.dist}/server/jacc/deploy" />
      -->

      <server:start name="jacc"/>

      <!-- ROOT.war is needed for confirmation that the server has started. But there is a test case "WebIntegrationUnitTestCase" that tries to replace the root context war. So delete the ROOT.war 
      <delete dir="${jboss.dist}/server/jacc/deploy/ROOT.war" />
     -->

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>

     <property name="jbosstest.secure" value="true"/>
     <property name="jboss.security.jacc" value="true" />
     <property name="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
     <propertyset id="jacc-tests-props">
        <propertyref prefix="java.security.auth"/>
		<propertyref prefix="jboss.security"/>
     </propertyset>

     <run-junit junit.patternset="jacc.includes"
        junit.configuration="JACC"
	junit.syspropertyset="jacc-tests-props" />

      <server:stop name="jacc"/>
   </target>

   <target name="tests-jacc-securitymgr"
     description="Tests run against a jboss server with JACC configured + security manager">
      <!-- Create the security manager enabled jacc -->
      <create-config baseconf="default" newconf="jacc-securitymgr" newconf-src="jacc">
       <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
          <!-- Previous broken and fragile detailed listing of deploy content
          <include name="deploy/jbossweb.sar/**"/>
          <include name="deploy/ROOT.war/**"/>
          <include name="deploy/hsqldb-ds.xml"/>
          <include name="deploy/jbossws.sar/**"/>
          <include name="deploy/client-deployer-service.xml"/>
          <include name="deploy/jmx-invoker-service.xml"/>
          <include name="deploy/jmx-console.war/**"/>
          <include name="deploy/jca-jboss-beans.xml"/>
          <include name="deploy/jboss-local-jdbc.rar"/>
          <include name="deploy/mail-service.xml"/>
          <include name="deploy/messaging/**"/>
          <include name="deploy/ejb3-interceptors-aop.xml"/>
          -->
       </patternset>
     </create-config>
     <server:start name="jacc-securitymgr"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>


      <property name="jbosstest.secure" value="true"/>
      <property name="jboss.security.jacc" value="true" />
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
		 <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="jacc.includes"
         junit.configuration="JACC+SecurityMgr"
         junit.syspropertyset="jacc-tests-props" />

     <server:stop name="jacc-securitymgr"/>
   </target>

   <target name="tests-jacc-security-allstarrole"
     description="Tests run against a jboss server with JACC configured + security manager">
      <!-- Create the security manager enabled jacc -->
      <create-config baseconf="default" newconf="jacc-security-allstarrole" newconf-src="jacc">
       <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
       </patternset>
     </create-config>

    <!-- Use the test policy provider -->
    <copy todir="${jboss.dist}/server/jacc-security-allstarrole/deployers" file="${build.resources}/test-configs/jacc-security-allstarrole/deployers/jacc-jboss-beans.xml" overwrite="true"/>
     <!-- Copy the jacc allStarRolePolicyProvider jar -->
    <copy todir="${jboss.dist}/server/jacc-security-allstarrole/lib" file="${build.lib}/jacc-allStarRolePolicyProvider.jar"/>

     <server:start name="jacc-security-allstarrole"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>

      <property name="jbosstest.secure" value="true"/>
      <property name="jboss.security.jacc" value="true" />
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
      <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
      <propertyref prefix="java.security.auth"/>
      <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="jacc.allstarrole.includes"
         junit.configuration="JACC+allstarrole"
         junit.syspropertyset="jacc-tests-props" />

     <server:stop name="jacc-security-allstarrole"/>
   </target>

   <!--
      | JSR196 Based Unit Tests
    -->
   <target name="tests-security-jaspi-unit"
     description="Tests run against a jboss server with jaspi configured">
      <create-config baseconf="default" newconf="jaspi">
	   <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
          <include name="lib/**"/>
          <!-- Previous broken and fragile detailed listing of deploy content
          <include name="deploy/jbossweb.sar/**"/>
          <include name="deploy/ROOT.war/**"/>
          <include name="deploy/hsqldb-ds.xml"/>
          <include name="deploy/client-deployer-service.xml"/>
          <include name="deploy/jmx-invoker-service.xml"/>
          <include name="deploy/jmx-console.war/**"/>
          <include name="deploy/jca-jboss-beans.xml"/>
          <include name="deploy/jboss-local-jdbc.rar"/>
          <include name="deploy/mail-service.xml"/>
	      <include name="deploy/messaging/**"/>
          <include name="deploy/ejb3-interceptors-aop.xml"/>
          -->
       </patternset>
     </create-config>
      <server:start name="jaspi"/>

     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>


      <property name="jbosstest.secure" value="true"/>
      <property name="java.security.auth.login.config"
        value="${build.resources}/security/auth.conf"/>
      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
      </propertyset>

      <propertyset id="jacc-tests-props">
         <propertyref prefix="java.security.auth"/>
		 <propertyref prefix="jboss.security"/>
      </propertyset>

      <run-junit junit.patternset="security.jaspi.includes" junit.configuration="tests-security-jaspi"/>

     <server:stop name="jaspi"/>
   </target>

<!-- Ldap Tests-->
   <target name="tests-ldap"
      description="Tests run against a jboss server with opends configured">
      <create-config baseconf="default" newconf="opends">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
            <!-- Previous broken and fragile detailed listing of deploy content
            <include name="deploy/jbossweb.sar/**"/>
            <include name="deploy/ROOT.war/**"/>
            <include name="deploy/hsqldb-ds.xml"/>
            <include name="deploy/client-deployer-service.xml"/>
            <include name="deploy/jmx-invoker-service.xml"/>
            <include name="deploy/jmx-console.war/**"/>
            <include name="deploy/jca-jboss-beans.xml"/>
            <include name="deploy/jboss-local-jdbc.rar"/>
            <include name="deploy/ejb3-interceptors-aop.xml"/>
            <include name="deploy/properties**"/>
            -->
         </patternset>
      </create-config>

      <copy file="${build.lib}/opends.sar"
        todir="${jboss.dist}/server/opends/deploy" />
      <server:start name="opends"/>

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>

     <property name="jbosstest.secure" value="true"/>
     <property name="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
     <property name="jboss.security.ldap.ctxfactory"
            value="com.sun.jndi.ldap.LdapCtxFactory"/>

     <propertyset id="opends-tests-props">
        <propertyref prefix="java.security.auth"/>
	<propertyref prefix="jboss.security"/>
     </propertyset>
     <run-junit junit.patternset="ldap.includes"
        junit.configuration="opends"
	junit.syspropertyset="opends-tests-props" />
      <server:stop name="opends"/>
   </target>


   <target name="tests-standalone-aop-unit">
      <!--
          <antcall target="tests-treecacheaop-unit" inheritRefs="true"/>
      -->
      <antcall target="tests-treecacheaopc-unit" inheritRefs="true"/>
      <antcall target="tests-baseaop-unit" inheritRefs="true"/>
   </target>

  <target name="tests-compatibility"
    description="Checks compatibility on SerialUUID" depends="init">
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="true"
      timeout="300000"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <jvmarg value="-XX:MaxPermSize=768m"/>
      <jvmarg value="-Xms256m"/>
      <jvmarg value="-Xmx512m"/>
      <sysproperty key="jboss.dist" file="${jboss.dist}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
        <propertyref prefix="jbosstest."/>
      </syspropertyset>

      <!-- This runs with a minimal classpath as the jboss classes need to
         be loaded in a seperate class loader.
      -->
      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="jboss.test.classpath"/>
        <path refid="jboss.varia.classpath"/>
      </classpath>

      <!--formatter type="xml" usefile="${junit.formatter.usefile}"/-->
      <sysproperty key="jboss-junit-configuration" value="tests-compatibility"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-compatibility.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <patternset refid="compatibility.includes"/>
        </fileset>
      </batchtest>
    </junit>
  </target>


   <target name="tests-treecacheaop-unit" depends="init">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg value="-Djava.system.class.loader=org.jboss.aop.standalone.SystemClassLoader"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/cache/standalone"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/-->
         <sysproperty key="jboss-junit-configuration" value="tests-treecacheaop-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-treecacheaop-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/cache/test/standAloneAop/*AopTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <target name="tests-treecacheaopc-unit" depends="init">
      <!-- pre-compile the aop classes -->
      <taskdef name="aopc" classname="org.jboss.aop.ant.AopC" classpathref="jboss.aop.classpath"/>
      <path id="aop.task.classpath">
         <path refid="javassist.classpath"/>
         <path refid="trove.classpath"/>
         <path refid="jboss.aop.classpath"/>
      <path refid="jboss.common.core.classpath"/>
      <path refid="jboss.common.logging.spi.classpath"/>
      <path refid="jboss.common.logging.log4j.classpath"/>
      <path refid="jboss.common.logging.jdk.classpath"/>
      </path>

      <aopc compilerclasspathref="aop.task.classpath">
         <classpath refid="thirdparty.classpath"/>
         <classpath path="${build.classes}"/>
         <src path="${build.classes}"/>
         <include name="org/jboss/test/cache/test/standAloneAop/**"/>
         <aoppath path="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
      </aopc>

      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/cache/standalone/META-INF/jboss-aop.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/cache/standalone"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-treecacheaopc-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-treecacheaopc-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/cache/test/standAloneAop/*AopTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <target name="tests-baseaop-unit" depends="init">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <sysproperty key="java.system.class.loader" value="org.jboss.aop.standalone.SystemClassLoader"/>
         <sysproperty key="jboss.aop.path" file="${source.resources}/aop/META-INF/jboss-aop.xml"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-baseaop-unit"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-baseaop-unit.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/aop/nonjunit/StandaloneTest.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX implementation tests that should run correctly.
    -->
   <target name="tests-jbossmx-implementation">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-implementation"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-implementation.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/implementation/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/implementation/TestCase.class"/>
               <exclude name="org/jboss/test/jmx/test/SecureJMXInvokerUnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX performance tests that should run correctly.
    -->
   <target name="tests-jbossmx-performance">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-performance"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-performance.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/performance/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/performance/TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | JBossMX compliance tests that should run correctly.
    -->
   <target name="tests-jbossmx-compliance">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      	 <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
      	 <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-jbossmx-compliance"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-jbossmx-compliance.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/jbossmx/compliance/**/*TestCase.class"/>
               <!-- Ignore the abstract class -->
               <exclude name="org/jboss/test/jbossmx/compliance/TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | IIOP test cases that should run successfully
    -->
   <target name="tests-iiop" unless="build.ewp">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg value="-Dj2ee.clientName=test"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
      	 <jvmarg value="-Djacorb.interop.sun=on"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-Djava.naming.factory.url.pkgs=org.jboss.naming.client"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.iiop.csiv2.SASClientInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="java.security.policy" value="${build.resources}/iiop/client.policy"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
            <!-- path refid="jboss.iiop.classpath"/ -->
            <pathelement path="${jboss.dist.common.lib}/jboss-iiop.jar"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-iiop"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-iiop.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <patternset refid="iiop.includes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

  <!-- Test the XML binding framework -->
  <target name="tests-xml-unit">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-xml-unit"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-xml-unit.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">

         <fileset dir="${build.classes}">
            <patternset refid="jbossxb.includes"/>
         </fileset>
      </batchtest>
    </junit>
  </target>

   <!-- Test StAX JAS-173  -->
   <target name="tests-stax" depends="maybejars">
     <mkdir dir="${build.reports}"/>
     <mkdir dir="${build.testlog}"/>
     <junit dir="${module.output}"
       printsummary="${junit.printsummary}"
       haltonerror="${junit.haltonerror}"
       haltonfailure="${junit.haltonfailure}"
       fork="${junit.fork}"
       timeout="${junit.timeout}"
       jvm="${junit.jvm}">

       <jvmarg line="${junit.jvm.options}"/>
       <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
       <sysproperty key="build.testlog" value="${build.testlog}"/>
       <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
       <!-- Pass along any jbosstest.* system properties -->
       <syspropertyset>
          <propertyref prefix="jbosstest."/>
       </syspropertyset>

       <classpath>
         <pathelement location="${build.classes}"/>
         <pathelement location="${build.resources}"/>
         <path refid="tests.classpath"/>
       </classpath>

       <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/-->
       <sysproperty key="jboss-junit-configuration" value="tests-stax"/>
       <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                  usefile="${junit.formatter.usefile}"
                  extension="-tests-stax.xml"/>

       <batchtest todir="${build.reports}"
          haltonerror="${junit.batchtest.haltonerror}"
          haltonfailure="${junit.batchtest.haltonfailure}"
          fork="${junit.batchtest.fork}">

          <fileset dir="${build.classes}">
             <patternset refid="stax.includes"/>
          </fileset>
       </batchtest>
     </junit>
   </target>

    <!-- Run the Web Services Tests-->
   <target name="tests-webservice"
      description="Execute Web Services Related Tests">

      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <!-- The crimson parser cannot do schema validation, which we need for jaxrpc-mapping.xml -->
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/security"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-webservice"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-webservice.xml"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/webservice/**/*TestCase.class"/>
               <include name="org/jboss/test/web/jbas8318/**/*TestCase.class"/>
               <exclude name="org/jboss/test/webservice/jbws309/**"/>
               <!-- if we are testing EWP, we need to exclude some tests -->
               <patternset refid="ewp.excludes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>
   
   <!-- Run the Web Services JAX-WS Tests-->
   <target name="tests-ws"
      description="Execute Web Services JAX-WS Related Tests">

      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="jbosstest.secure" value="true"/>

         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/security/tst.policy"/>
         <sysproperty key="java.security.auth.login.config" value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <!-- The crimson parser cannot do schema validation, which we need for jaxrpc-mapping.xml -->
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}/security"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-webservice"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-ws.xml"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/ws/**/*TestCase.class"/>
               <!-- excluding tests which need to have node0 defined as 127.0.0.1, see JBPAPP-7113 -->
               <exclude name="org/jboss/test/ws/jaxws/ejb3Integration/WebServiceTestCase.class"/>
               <exclude name="org/jboss/test/ws/jaxws/webserviceref/WebServiceRefClientTestCase.class"/>
               <exclude name="org/jboss/test/ws/jaxws/webserviceref/WebServiceRefEJB3TestCase.class"/>
               <exclude name="org/jboss/test/ws/jaxws/webserviceref/WebServiceRefServletTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
    | Standard jaxr tests that should run successfully against a
    | JBoss server distribution build that contains jaxr.
   -->
   <!-- Test for JAXR under the Web Services Umbrella -->
   <target name="tests-scout-jaxr" unless="build.ewp">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
            printsummary="${junit.printsummary}"
            haltonerror="${junit.haltonerror}"
            haltonfailure="${junit.haltonfailure}"
            fork="${junit.fork}"
            timeout="${junit.timeout}"
            jvm="${junit.jvm}"
            failureProperty="tests.failure">

         <!-- JPDA Debugging begin-->
         <!--
            <jvmarg value="-Xdebug"/>
            <jvmarg value="-Xnoagent"/>
            <jvmarg value="-Djava.compiler=NONE"/>
            <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8686"/>
         -->
         <!-- End JPDA Debuuging begin-->

         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="javax.xml.registry.ConnectionFactoryClass" value="org.apache.ws.scout.registry.ConnectionFactoryImpl"/>
         <sysproperty key="jaxr.query.url" value="http://${node0}:8080/juddi/inquiry"/>
         <sysproperty key="jaxr.publish.url" value="http://${node0}:8080/juddi/publish"/>
         <sysproperty key="scout.proxy.transportClass" value="org.jboss.jaxr.scout.transport.SaajTransport"/>
         <sysproperty key="host.name" value="${node0}"/>
         <sysproperty key="jndi.bind.name" value="JAXR"/>
         <sysproperty key="jaxr.debug" value="true"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
           <pathelement location="${build.classes}"/>
	   <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-scout-jaxr"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="${junit.formatter.usefile}"
                    extension="-tests-scout-jaxr.xml"/>
	 <formatter type="plain" usefile="${junit.formatter.usefile}"/>

	 <batchtest todir="${build.reports}"
	    haltonerror="${junit.batchtest.haltonerror}"
	    haltonfailure="${junit.batchtest.haltonfailure}"
	    fork="${junit.batchtest.fork}">

	    <fileset dir="${build.classes}">
	       <patternset refid="jaxr.includes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   
   <!-- The scoped AOP tests need a classloader hook -->
   <target name="tests-aop-scoped"
      description="AOP tests requiring a native classloader hook">

      <!-- copy across the pluggable instrumentor -->
      <copy todir="${jboss.dist}/bin" file="${jboss.aop.lib}/pluggable-instrumentor.jar"/>
      <create-config baseconf="all" newconf="scoped-aop-jdk50">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="scoped-aop-jdk50"/>

	   <antcall target="run-tests-aop-scoped" inheritRefs="true"/>
      <server:stop name="scoped-aop-jdk50"/>

      <delete file="${jboss.dist}/bin/pluggable-instrumentor.jar"/>
   </target>
   <target name="tests-aop-scoped-generated-advisor"
      description="AOP tests requiring a native classloader hook for JDK 5.0">

      <!-- copy across the pluggable instrumentor -->
      <copy todir="${jboss.dist}/bin" file="${jboss.aop.lib}/pluggable-instrumentor.jar"/>
      <create-config baseconf="all" newconf="scoped-aop-generated-advisor">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="scoped-aop-generated-advisor"/>

       <run-junit junit.patternset="aop-with-classloader.includes"/>

      <server:stop name="scoped-aop-generated-advisor"/>

      <delete file="${jboss.dist}/bin/pluggable-instrumentor.jar"/>
   </target>
   <target name="run-tests-aop-scoped"
     description="AOP tests requiring a native classloader hook">
       <run-junit junit.patternset="aop-with-classloader.includes" junit.configuration="aop-scoped"/>
   </target>
   <!-- Test for ws-bpel integration -->
   <target name="tests-bpel">
      <!-- define tasks used in this target -->
      <taskdef name="webdbschema" classname="org.jbpm.bpel.ant.WebDBSchemaTask">
         <classpath refid="jbpm.bpel.classpath" />
      </taskdef>
      <taskdef name="webdeploy" classname="org.jbpm.bpel.ant.WebDeployTask">
         <classpath refid="jbpm.bpel.classpath" />
      </taskdef>
      <!-- Create the sso enabled tomcat config starting with the default config -->
      <create-config baseconf="default" newconf="jbpm-bpel">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <server:start name="jbpm-bpel"/>
      <webdbschema operation="create" host="${node0}"/>
      <webdeploy par="${build.lib}/bpel-hello.par" host="${node0}" />
      <run-junit junit.patternset="jbpm-bpel.includes" junit.configuration="tests-bpel"/>
      <webdbschema operation="drop" host="${node0}"/>
      <server:stop name="jbpm-bpel"/>
   </target>

	
   <!-- ============================================= JBM Targets ============================= -->
	
   <!--  Starts two servers, run few simultaneous tests, kill the server only once and get the results of all the tests  -->
   <target name="tests-jbossmessaging-cluster"
   	   description="Run JBM in cluster" unless="build.ewp">
   	
   	<!-- Default jgroups stack to use -->
   	<property name="jboss.default.jgroups.stack" value="udp"/>
   	<!-- Default configuration to build the test config from -->
      <property name="baseconf" value="all"/>

  	  <delete dir="${jboss.dist}/server/jbm-cluster1" />
   	  <delete dir="${jboss.dist}/server/jbm-cluster2" />
      <create-config baseconf="${baseconf}" newconf="jbm-cluster1">
         <patternset>
            <include name="conf/**"/>
            <include name="deploy/**"/>
            <include name="deployers/**"/>
            <include name="deploy-hasingleton/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>
      <create-config baseconf="${baseconf}" newconf="jbm-cluster2">
         <patternset>
            <include name="conf/**"/>
             <include name="deploy/**"/>
             <include name="deployers/**"/>
             <include name="deploy-hasingleton/**"/>
             <include name="lib/**"/>
         </patternset>
      </create-config>

      <server:start name="jbm-cluster1"/>
      <server:start name="jbm-cluster2"/>

      <antcall target="exec-jbmcluster"/>

      <!--  I'm not stopping jbm-cluster2 as this server will be killed during the test -->            
      <server:stop name="jbm-cluster1"/>
   	   
   </target>
   
  <!-- Test the Messaging JMS provider -->
  <target name="exec-jbmcluster">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.useJBM" value="true"/>
      
      <sysproperty key="jbosstest.cluster.node0" value="${node0}"/>
      <sysproperty key="jbosstest.cluster.node0.http.url" value="${node0.http.url}"/>
      <sysproperty key="jbosstest.cluster.node0.jndi.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.cluster.node0.hajndi.url" value="${node0.hajndi.url}"/>
      <sysproperty key="jbosstest.cluster.node1" value="${node1}"/>
      <sysproperty key="jbosstest.cluster.node1.http.url" value="${node1.http.url}"/>
      <sysproperty key="jbosstest.cluster.node1.jndi.url" value="${node1.jndi.url}"/>
      <sysproperty key="jbosstest.cluster.node1.hajndi.url" value="${node1.hajndi.url}"/>
      

        <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <pathelement location="${build.resources}/jbossmessaging"/>
        <pathelement location="${build.lib}/jbossmessagingtest.jar"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-jbossmessaging-cluster"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-jbossmessaging.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">
         <fileset dir="${build.classes}">
            <patternset refid="jbossmessaging-clustering.includes"/>
         </fileset>
      </batchtest>
    </junit>
   </target>
  

   


   <!--
     | Run JMS tests against the Messaging JMS provider
   -->
   <target name="tests-jbossmessaging"
      description="Run JMS tests against the Messaging JMS provider" unless="build.ewp">

      <property name="baseconf" value="all"/>

   	  <antcall target="create-server-jbossmessaging"/>
   	
      <server:start name="jbossmessaging"/>
      <antcall target="tests-jbossmessaging-unit" />
      <server:stop name="jbossmessaging"/>
   </target>
	
   <target name ="create-server-jbossmessaging">
    <!-- Create a separate messaging config -->
    <create-config baseconf="${baseconf}" newconf="jbossmessaging">
       <patternset>
          <include name="conf/**"/>
          <include name="deployers/**"/>
          <include name="deploy/**"/>
			   <include name="lib/**"/>
       </patternset>
    </create-config>
   </target>



  <!-- Test the Messaging JMS provider -->
  <target name="tests-jbossmessaging-unit">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <junit dir="${module.output}"
      printsummary="${junit.printsummary}"
      haltonerror="${junit.haltonerror}"
      haltonfailure="${junit.haltonfailure}"
      fork="${junit.fork}"
      timeout="${junit.timeout}"
      jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.useJBM" value="true"/>

        <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <pathelement location="${build.resources}/jbossmessaging"/>
        <pathelement location="${build.lib}/jbossmessagingtest.jar"/>
        <path refid="tests.classpath"/>
      </classpath>

      <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
      <sysproperty key="jboss-junit-configuration" value="tests-jbossmessaging"/>
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-jbossmessaging.xml"/>

      <batchtest todir="${build.reports}"
        haltonerror="${junit.batchtest.haltonerror}"
        haltonfailure="${junit.batchtest.haltonfailure}"
        fork="${junit.batchtest.fork}">
         <fileset dir="${build.classes}">
            <patternset refid="jbossmessaging.includes"/>
            <patternset refid="badtest.excludes"/>
         </fileset>
      </batchtest>
    </junit>
   </target>
  
   <!-- ========================================= END JBM Targets ============================= -->

  <target name="tests-classloader-leak">

    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    <create-config baseconf="all" newconf="classloader-leak">
      <patternset>
        <include name="conf/**"/>
        <include name="deploy/**"/>
        <include name="deployers/**"/>
        <include name="lib/**"/>
      </patternset>
    </create-config>
    <server:start name="classloader-leak"/>
    
    <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="${junit.fork}"
      timeout="${junit.timeout}" jvm="${junit.jvm}">

      <jvmarg line="${junit.jvm.options}"/>
      <!-- Used for JGroups -->
      <jvmarg value="-Dbind.address=${node0}"/>
      <sysproperty key="jboss.dist" value="${jboss.dist}"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
        <propertyref prefix="jbosstest."/>
      </syspropertyset>
      <classpath>
        <pathelement location="${build.classes}"/>
        <pathelement location="${build.resources}"/>
        <path refid="tests.classpath"/>
      </classpath>
      
      <!--sysproperty key="jboss-junit-configuration" value="classloader-leak"/-->
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-ClassloaderLeak.xml"/>

      <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">

        <fileset dir="${build.classes}">
          <patternset refid="classloader-leak.includes"/>
          <patternset refid="badtest.excludes"/>
        </fileset>
      </batchtest>
    </junit>
    
    <server:stop  name="classloader-leak"/>
  </target>

  <!-- script tests -->
  <target name="tests-scripts">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    
    <create-config baseconf="all" newconf="scripts">
      <patternset>
	<include name="conf/**"/>
	<include name="deploy/**"/>
	<include name="deployers/**"/>
	<include name="deploy-hasingleton/**"/>
	<include name="farm/**"/>
	<include name="lib/**"/>
      </patternset>
    </create-config>
    <server:start name="scripts"/>
    
    <!-- script tests which require a started server -->
    <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="${junit.fork}"
	   timeout="${junit.timeout}" jvm="${junit.jvm}">
      
      <jvmarg value="${junit.jvm.options}"/>
      <!-- Used for JGroups -->
      <jvmarg value="-Dbind.address=${node0}"/>
      <sysproperty key="jboss.dist" value="${jboss.dist}"/>
      <sysproperty key="jbosstest.server.config" value="scripts"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.server.host.url" value="${node0.url}"/>
      <sysproperty key="java.net.preferIPv4Stack" value="${java.net.preferIPv4Stack}" />
      <sysproperty key="java.net.preferIPv6Addresses" value="${java.net.preferIPv6Addresses}" />
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
	<propertyref prefix="jbosstest."/>
      </syspropertyset>
      <classpath>
	<pathelement location="${build.classes}"/>
	<pathelement location="${build.resources}"/>
	<path refid="tests.classpath"/>
      </classpath>
      
      <!--sysproperty key="jboss-junit-configuration" value="classloader-leak"/-->
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-scripts.xml"/>
      
      <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">
	
	<fileset dir="${build.classes}">
          <include name="**/test/scripts/test/TwiddleTestCase.class"/>
          <include name="**/test/scripts/test/ProbeTestCase.class"/>
          <include name="**/test/scripts/test/WsclientTestCase.class"/>
	</fileset>
      </batchtest>
    </junit>
    <server:stop  name="scripts"/>
   </target>
	
 <target name="tests-scripts-noserver">
    <mkdir dir="${build.reports}"/>
    <mkdir dir="${build.testlog}"/>
    
    <create-config baseconf="default" newconf="scripts-noserver">
      <patternset>
	<include name="conf/**"/>
	<include name="deploy/**"/>
	<include name="deployers/**"/>
	<include name="lib/**"/>
      </patternset>
    </create-config>
    
    <!-- script tests which start their own servers -->
    <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="${junit.fork}"
	   timeout="${junit.timeout}" jvm="${junit.jvm}">
      
      <jvmarg value="${junit.jvm.options}"/>
      <!-- Used for JGroups -->
      <jvmarg value="-Dbind.address=${node0}"/>
      <sysproperty key="jboss.dist" value="${jboss.dist}"/>
      <sysproperty key="jbosstest.server.config" value="scripts-noserver"/>
      <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
      <sysproperty key="build.testlog" value="${build.testlog}"/>
      <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
      <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
      <sysproperty key="jbosstest.server.host" value="${node0}"/>
      <sysproperty key="jbosstest.server.host.url" value="${node0.url}"/>
      <sysproperty key="java.net.preferIPv4Stack" value="${java.net.preferIPv4Stack}" />
      <sysproperty key="java.net.preferIPv6Addresses" value="${java.net.preferIPv6Addresses}" />
      <!-- Pass along any jbosstest.* system properties -->
      <syspropertyset>
		<propertyref prefix="jbosstest."/>
      </syspropertyset>
      <classpath>
		<pathelement location="${build.classes}"/>
		<pathelement location="${build.resources}"/>
		<path refid="tests.classpath"/>
      </classpath>
      
      <!--sysproperty key="jboss-junit-configuration" value="classloader-leak"/-->
      <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}" extension="-scripts-noserver.xml"/>
      
      <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">
	
	  <fileset dir="${build.classes}">
         <include name="**/test/scripts/test/RunTestCase.class"/>
         <include name="**/test/scripts/test/ShutdownTestCase.class"/>
         <include name="**/test/scripts/test/WsconsumeTestCase.class"/>
         <include name="**/test/scripts/test/WsprovideTestCase.class"/>
         <include name="**/test/scripts/test/WstoolsTestCase.class"/>
         <include name="**/test/scripts/test/PasswordToolTestCase.class"/>
	  </fileset>
      </batchtest>
    </junit>
  </target>

	<!--
      | Run all database related tests
    -->
   <target name="tests-db" depends="run-db-tests, tests-report-html"/>

   <target name="run-db-tests" depends="maybejars">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.iterationcount" value="2"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
         </classpath>

         <!-- formatter type="xml" usefile="${junit.formatter.usefile}"/ -->
         <sysproperty key="jboss-junit-configuration" value="tests-db"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                 usefile="${junit.formatter.usefile}"
                 extension="-tests-db.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="**/bank/**/*StressTestCase.class"/>
               <include name="**/bmp/**/*UnitTestCase.class"/>
               <include name="**/cmp2/**/*UnitTestCase.class"/>
               <include name="**/cmp2/**/*StressTestCase.class"/>
               <include name="**/dbtest/**/*UnitTestCase.class"/>
               <include name="**/deadlock/**/*StressTestCase.class"/>
               <include name="**/entityexc/**/*UnitTestCase.class"/>
               <include name="**/idgen/**/*UnitTestCase.class"/>
               <include name="**/perf/**/*UnitTestCase.class"/>
               <include name="**/testbean/**/*UnitTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <!--
      | Run testcases in a single directory by specifing the test directory
      | name in -Dtest=dirname in tests/dirname/test/**TestCase.class
    -->
   <target name="test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each run has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <jvmarg value="-Djava.security.manager"/>
         <jvmarg value="-Dbind.address=${env.MYTESTIP_1}"/>
         <jvmarg value="-Djava.security.policy==${build.resources}/client.policy"/>
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" value="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jboss.vfs.forceCopy" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/${test}/**/*TestCase.class"/>
               <patternset refid="badtest.excludes"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Run iiop testcases in a single directory by specifing the test
      | directory name in -Dtest=dirname in tests/dirname/test/**TestCase.class
    -->
   <target name="iiop-test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each run has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>

         <jvmarg value="-Dj2ee.clientName=test"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
      	 <jvmarg value="-Djacorb.interop.sun=on"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-Djava.naming.factory.url.pkgs=org.jboss.naming.client"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.iiop.csiv2.SASClientInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <sysproperty key="java.security.policy" value="${build.resources}/iiop/client.policy"/>
         <sysproperty key="log4j.properties" file="${build.resources}/log4j.properties"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <path refid="tests.classpath"/>
            <!-- path refid="jboss.iiop.classpath"/ -->
            <pathelement path="${jboss.dist.common.lib}/jboss-iiop.jar"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>

         <batchtest todir="${build.reports}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}">

            <fileset dir="${build.classes}">
               <include name="org/jboss/test/${test}/**/*TestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!--
      | Run a single testcase by specifing the fully qualified class name
      | of the unit test using the test property, -Dtest=org.jboss.test....
      | Here you specify the testcase class, not the directory
    -->
   <target name="one-test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         filtertrace="${junit.filtertrace}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
         showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>

         <!--
         <jvmarg value="-Xdebug"/>
         <jvmarg value="-Xnoagent"/>
         <jvmarg value="-Djava.compiler=NONE"/>
         <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>
         -->

         <!--jvmarg value="-Djava.security.debug=all"/ -->

         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <sysproperty key="jboss.dist" value="${jboss.dist}"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <!-- [JBAS-3969] IOException: unknown protocol: vfsfile -->
         <sysproperty key="java.protocol.handler.pkgs" value="org.jboss.virtual.protocol"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.resource1.server.host" value="${node2}"/>
         <sysproperty key="jbosstest.resource2.server.host" value="${node3}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="javax.net.ssl.trustStore"
            value="${build.resources}/security/tst.keystore"/>
         <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>
         <sysproperty key="jboss.vfs.forceCopy" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <test todir="${build.reports}" name="${test}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}"/>
      </junit>
   </target>

   <target name="one-test-debug" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
        printsummary="${junit.printsummary}"
        haltonerror="${junit.haltonerror}"
        haltonfailure="${junit.haltonfailure}"
        fork="${junit.fork}"
        timeout="${junit.timeout}"
        jvm="${junit.jvm}">

          <jvmarg value="-verbose:gc"/>

          <jvmarg value="-Xdebug"/>
          <jvmarg value="-Xnoagent"/>
          <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8787"/>
          <jvmarg line="${junit.jvm.options}"/>

        <!-- Used for JGroups -->
        <jvmarg value="-Dbind.address=${node0}"/>
        <sysproperty key="jboss.dist" value="${jboss.dist}"/>
        <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
        <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
        <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
        <sysproperty key="jbosstest.server.host" value="${node0}"/>
        <sysproperty key="build.testlog" value="${build.testlog}"/>
        <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
        <sysproperty key="jbosstest.secure" value="true"/>
        <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
        <sysproperty key="jbosstest.server.host" value="${node0}"/>
        <!-- Pass along any jbosstest.* system properties -->
        <syspropertyset>
           <propertyref prefix="jbosstest."/>
           <propertyref prefix="java.rmi."/>
           <propertyref prefix="node0"/>
           <propertyref prefix="node1"/>
        </syspropertyset>
        <sysproperty key="java.security.auth.login.config"
          value="${build.resources}/security/auth.conf"/>
        <sysproperty key="javax.net.ssl.trustStore"
          value="${build.resources}/security/tst.keystore"/>
        <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>

        <classpath>
          <pathelement location="${build.classes}"/>
          <pathelement location="${build.resources}"/>
          <!-- Include for those tests that need common security resources -->
          <pathelement location="${build.resources}/security"/>
          <path refid="tests.classpath"/>
        </classpath>

        <formatter type="plain" usefile="${junit.formatter.usefile}"/>
        <formatter type="xml" usefile="${junit.formatter.usefile}"/>

        <test todir="${build.reports}" name="${test}"
          haltonerror="${junit.batchtest.haltonerror}"
          haltonfailure="${junit.batchtest.haltonfailure}"
          fork="${junit.batchtest.fork}"/>
      </junit>
    </target>


   <!--
      | Run a single testcase by specifing the fully qualified class name
      | of the unit test using the test property, -Dtest=org.jboss.test....
      | Here you specify the testcase class, not the directory
    -->
   <target name="one-iiop-test" if="test"
      description="Execute a single test.">
      <mkdir dir="${build.reports}"/>
      <mkdir dir="${build.testlog}"/>
      <!-- Remove the test.log so each test has a fresh log -->
      <delete file="${build.testlog}/test.log"/>
      <junit dir="${module.output}"
         printsummary="${junit.printsummary}"
         haltonerror="${junit.haltonerror}"
         haltonfailure="${junit.haltonfailure}"
         fork="${junit.fork}"
         timeout="${junit.timeout}"
      	 showoutput="${junit.showoutput}"
         jvm="${junit.jvm}">

         <jvmarg line="${junit.jvm.options}"/>
<!--         <jvmarg value="-Xdebug"/>-->
<!--         <jvmarg value="-Xnoagent"/>-->
<!--         <jvmarg value="-Djava.compiler=NONE"/>-->
<!--         <jvmarg value="-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>-->
         <!-- Used for JGroups -->
         <jvmarg value="-Dbind.address=${node0}"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBClass=org.jacorb.orb.ORB"/>
         <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=org.jacorb.orb.ORBSingleton"/>
         <jvmarg value="-Djacorb.orb.print_version=off"/>
         <jvmarg value="-Djacorb.log.default.verbosity=0"/>
         <jvmarg value="-Djacorb.interop.strict_check_on_tc_creation=off"/>
      	 <jvmarg value="-Djacorb.interop.sun=on"/>
         <jvmarg value="-Djacorb.log.loggerFactory=org.jboss.util.Log4jLoggerFactory"/>
         <jvmarg value="-Djacorb.security.ssl.client.supported_options=0"/>
         <jvmarg value="-Djacorb.security.ssl.client.required_options=0"/>
         <jvmarg value="-DORBInitRef.NameService=corbaloc::${node0}:3528/JBoss/Naming/root"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.tm.iiop.TxClientInterceptorInitializer"/>
         <jvmarg value="-Dorg.omg.PortableInterceptor.ORBInitializerClass.org.jboss.iiop.csiv2.SASClientInitializer"/>
         <jvmarg value="-Djava.security.manager"/>
         <jvmarg value="-Djava.security.policy==${build.resources}/iiop/client.policy"/>
         <jvmarg value="-Djava.naming.factory.url.pkgs=org.jboss.naming.client"/>
         <jvmarg value="-Dj2ee.clientName=test"/>
         <sysproperty key="java.endorsed.dirs" value="${jboss.dist}/lib/endorsed"/>
         <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
         <sysproperty key="build.testlog" value="${build.testlog}"/>
         <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
         <sysproperty key="jbosstest.secure" value="true"/>
         <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
         <sysproperty key="jbosstest.server.host" value="${node0}"/>
         <sysproperty key="jbosstest.resource1.server.host" value="${node2}"/>
         <sysproperty key="jbosstest.resource2.server.host" value="${node3}"/>
         <!-- Pass along any jbosstest.* system properties -->
         <syspropertyset>
            <propertyref prefix="jbosstest."/>
         </syspropertyset>
         <sysproperty key="java.security.auth.login.config"
            value="${build.resources}/security/auth.conf"/>
         <sysproperty key="javax.net.ssl.trustStore"
            value="${build.resources}/security/tst.keystore"/>
         <sysproperty key="org.jboss.security.ignoreHttpsHost" value="true"/>

         <classpath>
            <pathelement location="${build.classes}"/>
            <pathelement location="${build.resources}"/>
            <!-- Include for those tests that need common security resources -->
            <pathelement location="${build.resources}/security"/>
            <path refid="tests.classpath"/>
         </classpath>

         <formatter type="xml" usefile="${junit.formatter.usefile}"/>
         <formatter type="plain" usefile="${junit.formatter.usefile}"/>

         <test todir="${build.reports}" name="${test}"
            haltonerror="${junit.batchtest.haltonerror}"
            haltonfailure="${junit.batchtest.haltonfailure}"
            fork="${junit.batchtest.fork}"/>
      </junit>
   </target>

   <!-- Misc tests of the testing framework itself
   -->
   <target name="tests-apache"
      description="Test that apache can be started/stopped from ant">
      <apache location="${apache.location}" action-type="start"/>
      <start-sleep seconds="15"/>
      <apache location="${apache.location}" action-type="stop"/>
      <start-sleep seconds="5"/>
   </target>

   <target name="tests-jboss-cluster"
      description="Test that two jboss cluster nodes can be started/stopped from ant">
      <server:start name="node0"/>
      <server:start name="node1"/>
      <start-sleep seconds="60"/>
      <server:stop name="node0"/>
      <server:stop name="node1"/>
   </target>

   <property name="aspects.root" value="${project.root}/aspects"/>

   <target name="tests-aspects"
	description="Runs the aspects tests against ALL configuration">
      <ant antfile="${aspects.root}/build-test50.xml" inheritAll="false" dir="${aspects.root}"/>
      <ant antfile="${aspects.root}/build-test50.xml" inheritAll="false" dir="${aspects.root}" target="tests">
      	<property name="node0" value="${node0}"/>
   	</ant>
   </target>

   <target name="validate-server-configs"
      description="Validate the start/stop of the testsuite server configs">
      <!-- minimal -->
      <server:start name="minimal"/>
      <copy file="${build.lib}/shutdown.sar"
         todir="${jboss.dist}/server/minimal/deploy" />
      <echo message="Minimal server started, stopping"/>
      <sleep seconds="5"/>
      <delete file="${jboss.dist}/server/minimal/deploy/shutdown.sar" />
      <sleep seconds="7"/>

      <!-- minimal -->
      <server:start name="all"/>
      <server:stop name="all"/>

      <!-- tests-apache-tomcat-clustering -->
      <create-cluster-node conf="node0"/>
      <server:start name="node0" />
      <create-cluster-node conf="node1"/>
      <server:start name="node1"/>

      <server:stop name="node0"/>
      <server:stop name="node1"/>
      <apache location="${apache.location}" action-type="stop"/>

      <!-- Test the default UDP stack -->
      <antcall target="tests-clustering-configure">
         <param name="jboss.default.jgroups.stack" value="udp"/>
      </antcall>
      <server:start name="cluster-udp-0"/>
      <server:start name="cluster-udp-1"/>
      <server:stop name="cluster-udp-0"/>
      <server:stop name="cluster-udp-1"/>

      <!-- Test a TCP stack.-->
      <antcall target="tests-clustering-configure">
         <param name="jboss.default.jgroups.stack" value="tcp"/>
      </antcall>
      <server:start name="cluster-tcp-0"/>
      <server:start name="cluster-tcp-1"/>
      <server:stop name="cluster-tcp-0"/>
      <server:stop name="cluster-tcp-1"/>

      <!-- Test the field UDP stack -->
      <antcall target="tests-clustering-field-configure">
         <param name="cluster.includes.refid" value="cluster.field.includes"/>
         <param name="jboss.default.jgroups.stack" value="udp"/>
         <param name="jbosstest.cluster.node0.config" value="cluster-field-udp-0"/>
         <param name="jbosstest.cluster.node1.config" value="cluster-field-udp-1"/>
      </antcall>

      <server:start name="cluster-field-udp-0"/>
      <server:start name="cluster-field-udp-1"/>
      <server:stop name="cluster-field-udp-0"/>
      <server:stop name="cluster-field-udp-1"/>
      <!-- Test the field TCP stack -->
      <antcall target="tests-clustering-field-configure">
         <param name="cluster.includes.refid" value="cluster.field.includes"/>
         <param name="jboss.default.jgroups.stack" value="tcp"/>
         <param name="jbosstest.cluster.node0.config" value="cluster-field-tcp-0"/>
         <param name="jbosstest.cluster.node1.config" value="cluster-field-tcp-1"/>
      </antcall>

      <server:start name="cluster-field-tcp-0"/>
      <server:start name="cluster-field-tcp-1"/>
      <server:stop name="cluster-field-tcp-0"/>
      <server:stop name="cluster-field-tcp-1"/>

      <!-- Create the sso enabled tomcat config starting with the all config -->
      <create-cluster-sso-node newconf="tomcat-sso-cluster0"/>
      <create-cluster-sso-node newconf="tomcat-sso-cluster1"/>

      <echo message="Modifying the node0 and node1 Tomcat configuration for REPL_SYNC/UseJK"/>
      <http-cluster-node-config-change conf="tomcat-sso-cluster0"/>
      <http-cluster-node-config-change conf="tomcat-sso-cluster1"/>

      <server:start name="tomcat-sso-cluster0"/>
      <server:start name="tomcat-sso-cluster1"/>

      <server:stop name="tomcat-sso-cluster0"/>
      <server:stop name="tomcat-sso-cluster1"/>

      <!-- tomcat-webctx -->
      <create-config baseconf="default" newconf="tomcat-webctx"
         newconf-src="tomcat-webctx">
         <patternset>
            <include name="conf/**"/>
            <include name="deployers/**"/>
            <include name="deploy/**"/>
            <include name="lib/**"/>
         </patternset>
      </create-config>

      <server:start name="tomcat-webctx"/>
      <server:stop name="tomcat-webctx"/>

      <!-- Test the example binding configuration -->
      <create-cluster-node conf="binding-manager1"/>
      <create-cluster-node conf="binding-manager2"/>
      <server:start name="binding-manager1"/>
      <server:start name="binding-manager2"/>

      <server:stop name="binding-manager1"/>
      <server:stop name="binding-manager2"/>
   </target>

   <!-- Reporting targets that generate reports from JUnit output.
   -->
   <target name="reports" depends="tests-report"
      description="Generates all reports."/>

   <target name="tests-report-clean">
      <delete dir="${build.reports}"/>
   </target>

   <target name="tests-report" depends="tests-report-html, tests-report-text, tests-report-xml">
      <tar tarfile="${module.output}/${TIMENOW}.tgz" compression="gzip" longfile="gnu">
         <tarfileset dir="${build.reports}/html" prefix="${TIMENOW}">
            <include name="**"/>
         </tarfileset>
      </tar>
   </target>

   <target name="tests-report-html" depends="compile-stylesheets">
      <mkdir dir="${build.reports}/html"/>
      <mkdir dir="${aspects.root}/output/reports"/>

      <junitreport todir="${build.reports}">
         <fileset dir="${build.reports}">
            <include name="TEST-*.xml"/>
         </fileset>
         <fileset dir="${aspects.root}/output/reports">
            <include name="TEST-*.xml"/>
         </fileset>
         <report format="frames"
            todir="${build.reports}/html"
            styledir="${build.stylesheets}"
            />
      </junitreport>
   </target>

   <!--
      | this currently spews logs of VariableReference crap, so it is turned
      | off by default.  Once this is fixed, it should be built after
      | tests-report-html
    -->
   <target name="tests-report-text" depends="tests-report-html">
      <mkdir dir="${build.reports}/text"/>

      <style basedir="${build.reports}"
         destdir="${build.reports}/text"
         extension=".txt"
         style="${build.stylesheets}/summary1b.xsl"
         includes="TESTS-TestSuites.xml">
         <param name="thedate" expression="${TIMENOW}"/>
         <param name="java_version" expression="${java.version}"/>
         <param name="java_vendor" expression="${java.vendor}"/>
         <param name="java_vm_specification_version" expression="${java.vm.specification.version}"/>
         <param name="java_vm_version" expression="${java.vm.version}"/>
         <param name="java_vm_name" expression="${java.vm.name}"/>
         <param name="java_vm_info" expression="${java.vm.info}"/>
         <param name="java_specification_version" expression="${java.specification.version}"/>
         <param name="java_class_version" expression="${java.class.version}"/>
         <param name="os_name" expression="${os.name}"/>
         <param name="os_arch" expression="${os.arch}"/>
         <param name="os_version" expression="${os.version}"/>
         <param name="builduid" expression="${TIMENOW}"/>
         <param name="results_web" expression="${results_web}"/>
      </style>
   </target>

   <target name="tests-report-xml" depends="tests-report-html">
      <mkdir dir="${build.reports}/xml"/>

      <style basedir="${build.reports}"
         destdir="${build.reports}/xml"
         extension=".xml"
         style="${build.stylesheets}/shortXmlSummary.xsl"
         includes="TESTS-TestSuites.xml">
         <param name="thedate" expression="${TIMENOW}"/>
         <param name="java_version" expression="${java.version}"/>
         <param name="java_vendor" expression="${java.vendor}"/>
         <param name="java_vm_specification_version"

            expression="${java.vm.specification.version}"/>
         <param name="java_vm_version" expression="${java.vm.version}"/>
         <param name="java_vm_name" expression="${java.vm.name}"/>
         <param name="java_vm_info" expression="${java.vm.info}"/>
         <param name="java_specification_version" expression="${java.specification.version}"/>
         <param name="java_class_version" expression="${java.class.version}"/>
         <param name="os_name" expression="${os.name}"/>
         <param name="os_arch" expression="${os.arch}"/>
         <param name="os_version" expression="${os.version}"/>
      </style>
   </target>

   <target name="tests-matrix" description="Executes only the version check compatibility suite. Use -Dmatrix-versions=[version container] for this task" depends="maybejars" if="matrix-versions"> 
 
     <fail message="Use -Dmatrix-versions=[version container] for this task" unless="matrix-versions"/>
     <fail message="Set -Djdk15= to a JDK1.5 installation" unless="HAVE_JDK_1.5"/>
     <!--<fail message="Set -Djdk16= to a JDK1.6 installation" unless="HAVE_JDK_1.6"/>-->

     <!-- testing interoperating with clients using the unified invokers over jboss remoting -->
     <test-compatibility client-version="4_2_3_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_3_0_GA_CP06_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_3_0_GA_CP07_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_3_0_GA_CP08_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_3_0_GA_CP09_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="4_3_0_GA_CP10_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_1_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_0_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_0_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_0_1_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_0_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_1_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility client-version="5_1_2_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <!-- testing interoperating with clients using the pooled invokers -->
     <test-compatibility-pooled-invokers client-version="4_2_3_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="4_3_0_GA_CP06_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="4_3_0_GA_CP07_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="4_3_0_GA_CP08_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="4_3_0_GA_CP09_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="4_3_0_GA_CP10_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_0_1_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_1_0_GA" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_0_0_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_0_1_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_1_0_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_1_1_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
     <test-compatibility-pooled-invokers client-version="5_1_2_GA_EAP" label="16c-16s" client-jdk="${jdk16}" server-jdk="${jdk16}" client-serialization-flag="-Dnone" serialization-flag="-Dnone"/>
   </target>
 
  <macrodef name="test-compatibility-pooled-invokers">
    <attribute name="client-version"/>
    <attribute name="label"/>
    <attribute name="client-jdk"/>
    <attribute name="server-jdk"/>
    <attribute name="client-serialization-flag"/>    
    <attribute name="serialization-flag"/>
    <sequential>
      <start-jboss conf="default" jvmargs="-Xms128m -Xmx512m -XX:MaxPermSize=512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <wait-on-host/>
      <antcall target="tests-standard-unit-matrix-version-pooled">
        <param name="matrix-configuration" value="@{client-version}-@{label}"/>
	<param name="junit-jvm-command" value="@{client-jdk}/bin/java"/>
        <param name="current-version-dir" value="${matrix-versions}/@{client-version}"/>
        <param name="client-serialization-flag" value="@{client-serialization-flag}"/>
      </antcall>
      <stop-jboss jvmargs="-Xms128m -Xmx512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <sleep seconds="240"/>
    </sequential>
  </macrodef>

  <macrodef name="test-compatibility">
    <attribute name="client-version"/>
    <attribute name="label"/>
    <attribute name="client-jdk"/>
    <attribute name="server-jdk"/>
    <attribute name="client-serialization-flag"/>    
    <attribute name="serialization-flag"/>
    <sequential>
      <start-jboss conf="default" jvmargs="-Xms128m -Xmx512m -XX:MaxPermSize=512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <wait-on-host/>
      <antcall target="tests-standard-unit-matrix-version">
        <param name="matrix-configuration" value="@{client-version}-@{label}"/>
        <param name="junit-jvm-command" value="@{client-jdk}/bin/java"/>
        <param name="current-version-dir" value="${matrix-versions}/@{client-version}"/>
        <param name="client-serialization-flag" value="@{client-serialization-flag}"/>
      </antcall>
      <stop-jboss jvmargs="-Xms128m -Xmx512m @{serialization-flag}" java.exec="@{server-jdk}/bin/java"/>
      <sleep seconds="240"/>
    </sequential>
  </macrodef>
 
   <target name="tests-standard-unit-matrix-version">
     <execute-matrix-unit test-name="bmp" parameter-filter="org/jboss/test/bmp/**/*TestCase.class"/>
     <execute-matrix-unit test-name="client" parameter-filter="org/jboss/test/client/**/*TestCase.class"/>
     <execute-matrix-unit test-name="cmp2" parameter-filter="org/jboss/test/cmp2/**/*TestCase.class"/>
     <execute-matrix-unit test-name="ejb3" parameter-filter="org/jboss/test/ejb3/**/unit/*TestCase.class"/>
     <execute-matrix-unit test-name="hibernate" parameter-filter="org/jboss/test/hibernate/test/*TestCase.class"/>
     <execute-matrix-unit test-name="management" parameter-filter="org/jboss/test/management/test/*TestCase.class"/>
     <execute-matrix-unit test-name="testbyvalue" parameter-filter="org/jboss/test/testbyvalue/test/**/*TestCase.class"/>
     <execute-matrix-unit test-name="transactions" parameter-filter="org/jboss/test/tm/test/TransactionManagerUnitTestCase.class"/>
     <!--
     <execute-matrix-unit test-name="webservice" parameter-filter="org/jboss/test/webservice/**/*TestCase.class"/>
     -->

     <execute-matrix-unit test-name="sec" parameter-filter="**/test/security/test/*UnitTestCase.class"/>
     <execute-matrix-unit test-name="sec-auth" parameter-filter="**/test/security/test/auth/*UnitTestCase.class"/>
     <execute-matrix-unit test-name="sec-ejb" parameter-filter="**/test/security/test/ejb/*TestCase.class"/>
     <execute-matrix-unit test-name="sec-jmx" parameter-filter="**/test/jmx/test/Secure*TestCase.class"/>
     <execute-matrix-unit test-name="sec-perf" parameter-filter="**/test/perf/test/SecurePerfStressTestCase.class"/>
     <execute-matrix-unit test-name="sec-timer" parameter-filter="**/test/timer/test/SecureTimerUnitTestCase.class"/>
   </target>
 
   <target name="tests-standard-unit-matrix-version-pooled">
     <execute-matrix-unit test-name="pooled-invoker" parameter-filter="org/jboss/test/pooled/test/**/BeanStressTestCase.class"/>
   </target>
 
   <macrodef name="execute-matrix-unit">
     <attribute name="test-name"/>
     <attribute name="parameter-filter"/>
     <sequential>
       <!-- this requires antcall as a property can't be redefined -->
       <antcall target="execute-matrix-unit-target">
         <param name="test-name" value="@{test-name}"/>
         <param name="parameter-filter" value="@{parameter-filter}"/>
       </antcall>
     </sequential>
   </macrodef>
 
   <target name="execute-matrix-unit-target">
     <echo message=">>>>>> Executing test=${test-name} filter=${parameter-filter}"/>
     <pathconvert pathSep="," dirSep="/" property="jbosstest.hometest">
       <path location="${build.classes}"/>
     </pathconvert>
 
     <pathconvert pathSep="," dirSep="/" property="jbosstest.executionlist">
       <path>
         <fileset dir="${build.classes}">
           <include name="${parameter-filter}"/>
           <!-- The following test excluded because they need jboss.jar to
                access the following classes not included with the client libs:
                org/jboss/ejb/plugins/cmp/jdbc/metadata/JDBCQueryMetaData
                org/jboss/metadata/ClientMetaData -->
           <exclude name="org/jboss/test/cmp2/commerce/QueryTest.class"/>
           <exclude name="org/jboss/test/cmp2/commerce/LimitOffsetTest.class"/>
           <exclude name="org/jboss/test/cmp2/commerce/CompleteUnitTestCase.class"/>
           <patternset refid="all.excludes"/>
         </fileset>
       </path>
     </pathconvert>

     <junit dir="${module.output}" printsummary="${junit.printsummary}" haltonerror="${junit.haltonerror}" haltonfailure="${junit.haltonfailure}" fork="true"
       timeout="${junit.timeout}" jvm="${junit-jvm-command}">
 
       <jvmarg line="${junit.jvm.options}"/>
       <!-- Used for JGroups -->
       <jvmarg value="-Dbind.address=${node0}"/>
       <jvmarg value="${client-serialization-flag}"/>
       <sysproperty key="jbosstest.deploy.dir" file="${build.lib}"/>
       <sysproperty key="build.testlog" value="${build.testlog}"/>
       <sysproperty key="log4j.configuration" value="file:${build.resources}/log4j.xml"/>
       <sysproperty key="jboss-junit-configuration" value="${test-name}_${matrix-configuration}"/>
       <sysproperty key="java.naming.provider.url" value="${node0.jndi.url}"/>
       <sysproperty key="jbosstest.server.host" value="${node0}"/>
       <!-- Pass along any jbosstest.* system properties -->
       <syspropertyset>
         <propertyref prefix="jbosstest."/>
       </syspropertyset>
       <classpath>
         <path refid="compatmatrix.classpath"/>
       </classpath>
       <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" usefile="${junit.formatter.usefile}"
         extension="-${test-name}_${matrix-configuration}.xml"/>
 
       <batchtest todir="${build.reports}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}">
 
         <fileset dir="${build.classes}">
           <include name="org/jboss/test/compatibility/test/matrix/MatrixTestContainer.class"/>
         </fileset>
       </batchtest>
     </junit>
 
   </target>
   
   <target name="check-build-type"><echo message="build.ewp is ${build.ewp} and version is ${version} and version.name is ${version.name}"/></target>
		
</project>
